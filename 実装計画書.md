# Rutin MVP 実装計画書

## 1. 前提・非目標
### 前提
- 6週間・1人でMVPを確実にリリースする
- 既存の要件定義書・設計ドキュメントを唯一の仕様とする
- 事故リスクが高い領域を先に固める（RLS / 監査 / webhook冪等 / 課金 / ギフト台帳）

### UI/UX前提（運用実態に合わせる）
- キャストは**スマホで返信する**前提で設計する
- すべての画面は**モバイル優先のレスポンシブ対応**を必須とする
- 主要操作は片手で完結できる配置・最小ステップを優先する
- 入力/送信/確認の導線は誤操作防止を最優先にする

### 非目標（今回やらないこと）
- 自動返信・自動送信
- 通話/Zoom等の音声・映像対応
- 添付ファイルの送受信
- 多言語対応
- 高度な離脱予測やAIによる自動介入
- ユーザーのWebログイン

---

## 2. マイルストーン（週/フェーズ）
### Week 1：基盤（DB/RLS/監査/環境）
- 全テーブル定義の確定
- RLSポリシー実装・検証
- 監査ログの基盤整備
- 環境変数・初期管理者運用の整理

### Week 2：webhook・冪等・受信基盤
- LINE/Stripe webhookの冪等基盤
- 受信保存、チェックイン処理
- 監査ログの流れ確立

### Week 3：管理画面（閲覧/検索/チャット基盤）
- ログイン/認可
- Inbox/ユーザー一覧/詳細の読み取り
- チャット履歴表示・メモ・誕生日フラグ
- 主要画面のモバイル優先レイアウト最適化

### Week 4：課金・価格管理
- サブスク同期の受け皿
- 価格 override 管理
- 価格変更操作の監査

### Week 5：ギフト/ポイント/配分
- ポイント購入導線・台帳反映
- ギフト送信トランザクション
- 配分ルール・計算結果

### Week 6：精算・テスト・安定化
- 精算バッチ作成→承認→支払完了
- Unit/E2Eテスト実装
- 重要操作のガード確認

---

## 3. 実装順序（依存関係つき）
1. **DBテーブル/インデックス → RLSポリシー → 監査ログ**
2. **webhook_events冪等 → LINE/Stripe webhook受信**
3. **管理画面（ログイン/認可） → Inbox/Users/Chatの読み取りUI**
4. **メモ/誕生日/代理返信/AI下書きの操作**
5. **価格管理（override/価格変更）**
6. **ポイント購入 → ギフト送信トランザクション → 配分計算**
7. **精算バッチ作成/承認/支払い**
8. **Vitest/E2Eの追加 → リグレッション検証**

---

## 4. GitHub Issue形式チケット一覧（1〜2日粒度）

> **UI/UX共通指示**：UI関連チケットは「モバイル優先・レスポンシブ対応」をDoDに含める。

### Issue 01：DB基盤作成
- **目的**：全機能の土台となるテーブル・制約を準備
- **変更候補**：`supabase/migrations/*`
- **実装ステップ**
  1. 要件定義の全テーブル作成
  2. index/unique制約追加
- **完了条件（DoD）**：全テーブルが作成でき、再適用で失敗しない
- **テスト観点**：Vitestなし
- **リスクとロールバック方法**：migrationをdownで戻す

### Issue 02：RLSポリシー実装
- **目的**：権限逸脱をDBで防止
- **変更候補**：`supabase/migrations/*`
- **実装ステップ**
  1. staff_rolesの取得条件
  2. 各テーブルのselect/insert/update制御
- **完了条件（DoD）**：Castが担当外を取得できない
- **テスト観点**：Vitestで権限ロジック検証
- **リスクとロールバック方法**：RLS削除で影響範囲大

### Issue 03：監査ログ基盤
- **目的**：重要操作の追跡性を保証
- **変更候補**：`actions/*`, `supabase/migrations/*`
- **実装ステップ**
  1. audit_logs table
  2. 共通書き込みユーティリティ
- **完了条件（DoD）**：任意の操作でログが残る
- **テスト観点**：Unitで書き込み結果検証
- **リスクとロールバック方法**：ログ失敗時は操作自体を止める

### Issue 04：webhook冪等基盤
- **目的**：重複受信の二重処理を防止
- **変更候補**：`app/api/webhooks/*`, `actions/*`
- **実装ステップ**
  1. webhook_eventsテーブル利用
  2. provider/event_idで重複拒否
- **完了条件（DoD）**：同イベントIDで二重処理されない
- **テスト観点**：Unitで冪等判定
- **リスクとロールバック方法**：冪等失敗時は停止

### Issue 05：LINE webhook受信
- **目的**：メッセージ・チェックイン受信保存
- **変更候補**：`app/api/webhooks/line/*`
- **実装ステップ**
  1. 署名検証
  2. messages(in)保存
  3. checkins upsert
- **完了条件（DoD）**：受信が保存される
- **テスト観点**：E2Eで擬似受信
- **リスクとロールバック方法**：失敗時はログ記録

### Issue 06：Stripe webhook受信
- **目的**：サブスク状態・ポイント購入反映
- **変更候補**：`app/api/webhooks/stripe/*`
- **実装ステップ**
  1. 署名検証
  2. subscription同期
  3. 購入ポイント台帳反映
- **完了条件（DoD）**：purchaseでledgerが増える
- **テスト観点**：E2Eで擬似webhook
- **リスクとロールバック方法**：冪等で防止

### Issue 07：ログイン/認可の基盤
- **目的**：スタッフログイン・RBAC制御
- **変更候補**：`app/(admin)/*`, `components/auth/*`
- **実装ステップ**
  1. ログインフォーム
  2. role取得・ガード
- **完了条件（DoD）**：未ログインは弾かれる
- **テスト観点**：E2E認証
- **リスクとロールバック方法**：権限バグは即停止

### Issue 08：Inbox一覧
- **目的**：優先度・未返信が見える
- **変更候補**：`app/(admin)/inbox/*`, `actions/inbox.ts`
- **実装ステップ**
  1. Inboxデータ取得
  2. SLA警告ロジック実装（プラン別閾値）
  3. 未報告判定（チェックイン2日なし + メッセージ2日なし）
  4. paused優先度低下
  5. フィルタ/表示
- **完了条件（DoD）**：SLA警告表示、未報告が上位、pausedが下位
- **テスト観点**：E2E-020〜023、UT-010〜013
- **リスクとロールバック方法**：一覧のみ閲覧

### Issue 09：ユーザー一覧/詳細
- **目的**：ユーザー検索と詳細閲覧
- **変更候補**：`app/(admin)/users/*`, `actions/users.ts`
- **実装ステップ**
  1. 一覧検索
  2. 詳細カード
- **完了条件（DoD）**：契約/メモ/履歴表示
- **テスト観点**：E2E-030
- **リスクとロールバック方法**：閲覧のみ

### Issue 10：チャット履歴・送信
- **目的**：返信・代理返信の基盤
- **変更候補**：`app/(admin)/chat/*`, `actions/messages.ts`
- **実装ステップ**
  1. 履歴表示
  2. 送信/代理返信
- **完了条件（DoD）**：送信が記録される
- **テスト観点**：E2E-040/041
- **リスクとロールバック方法**：送信機能を停止

### Issue 11：メモ・誕生日フラグ
- **目的**：メモ更新・誕生日送信記録
- **変更候補**：`actions/memos.ts`
- **実装ステップ**
  1. upsertMemo
  2. markBirthdayCongratulated
- **完了条件（DoD）**：履歴が残る
- **テスト観点**：E2E-031〜033
- **リスクとロールバック方法**：書き込み停止

### Issue 12：AI下書き生成
- **目的**：1日3回制限のAI案生成
- **変更候補**：`actions/ai.ts`
- **実装ステップ**
  1. 制限判定
  2. 3案保存
- **完了条件（DoD）**：4回目は拒否
- **テスト観点**：E2E-050/051
- **リスクとロールバック方法**：AI機能停止

### Issue 13：価格管理（override/変更）
- **目的**：キャスト別価格・変更操作
- **変更候補**：`actions/admin/pricing.ts`, `app/(admin)/admin/pricing/*`
- **実装ステップ**
  1. override CRUD
  2. 価格変更操作（次回更新 / 即時の選択UI）
  3. 確認ダイアログ（影響ユーザー数表示）
  4. 監査ログ記録
- **完了条件（DoD）**：次回更新がデフォルト、監査ログが残る
- **テスト観点**：E2E-080、UT-018
- **リスクとロールバック方法**：価格変更停止

### Issue 14：ポイント購入導線
- **目的**：Checkout作成
- **変更候補**：`actions/gifts.ts`, `app/(public)/points/*`
- **実装ステップ**
  1. checkout session作成
  2. リダイレクト
- **完了条件（DoD）**：URL生成成功
- **テスト観点**：E2E-090
- **リスクとロールバック方法**：導線停止

### Issue 15：ギフト送信トランザクション
- **目的**：ledger/revenue/payout/messagesの整合
- **変更候補**：`actions/gifts.ts`
- **実装ステップ**
  1. 残高チェック
  2. トランザクション処理
- **完了条件（DoD）**：4系統のレコード一致
- **テスト観点**：UT-006/007/E2E-092/093
- **リスクとロールバック方法**：送信停止

### Issue 16：配分ルール・計算
- **目的**：global/castの配分計算
- **変更候補**：`actions/admin/payout-rules.ts`
- **実装ステップ**
  1. ルール解決
  2. payout_calculations保存
- **完了条件（DoD）**：税抜×%が一致
- **テスト観点**：UT-001/017
- **リスクとロールバック方法**：計算停止

### Issue 17：精算バッチ
- **目的**：バッチ作成→承認→支払完了
- **変更候補**：`actions/admin/settlements.ts`
- **実装ステップ**
  1. 期間集計
  2. approve/paid更新
- **完了条件（DoD）**：状態遷移が正しい
- **テスト観点**：E2E-100〜102
- **リスクとロールバック方法**：状態更新停止

### Issue 18：監査ログ閲覧
- **目的**：監査検索画面
- **変更候補**：`app/(admin)/admin/audit/*`, `actions/audit.ts`
- **実装ステップ**
  1. 検索/一覧
  2. 詳細表示
- **完了条件（DoD）**：Admin/Supervisorのみ閲覧
- **テスト観点**：E2E-110/111
- **リスクとロールバック方法**：閲覧停止

### Issue 19：Vitestロジック
- **目的**：税・配分・冪等等のロジック検証
- **変更候補**：`tests/unit/*`
- **実装ステップ**
  1. UT-001〜020実装
- **完了条件（DoD）**：全テストが通る
- **テスト観点**：Vitest
- **リスクとロールバック方法**：テスト無効化はNG

### Issue 20：Playwright E2E
- **目的**：主要導線と権限制御の統合検証
- **変更候補**：`tests/e2e/*`
- **実装ステップ**
  1. E2E-001〜111実装
- **完了条件（DoD）**：主要ケースが緑
- **テスト観点**：Playwright
- **リスクとロールバック方法**：テスト対象縮小

### Issue 21：ユーザー認証トークン実装（JWT）
- **目的**：ユーザー向けWebページの認証基盤
- **変更候補**：`lib/auth.ts`, `app/(public)/*`
- **実装ステップ**
  1. JWT生成・検証ユーティリティ作成
  2. ミドルウェアでトークン検証
  3. Server Actionでline_user_id取得
- **完了条件（DoD）**：トークンなしでアクセス拒否、有効期限切れ拒否
- **テスト観点**：Unitでトークン検証ロジック
- **リスクとロールバック方法**：認証失敗時はエラー画面表示

### Issue 22：チェックインFlex Message実装
- **目的**：LINEでのチェックインUI改善
- **変更候補**：`app/api/webhooks/line/*`, `lib/line.ts`
- **実装ステップ**
  1. Flex Message JSONテンプレート作成
  2. リッチメニューボタンからFlex Message送信
  3. postback受信・DB保存
- **完了条件（DoD）**：◯△×選択でDB記録、自動返信なし
- **テスト観点**：E2Eでpostback受信確認
- **リスクとロールバック方法**：従来のテキスト方式に戻す

### Issue 23：初期データ投入（ギフト・ポイント商品）
- **目的**：MVP起動時の初期データ準備
- **変更候補**：`supabase/migrations/*`
- **実装ステップ**
  1. ギフトカタログ8商品追加
  2. ポイント商品4商品追加
  3. マイグレーションで冪等性確保
- **完了条件（DoD）**：再実行しても重複しない
- **テスト観点**：マイグレーション再実行確認
- **リスクとロールバック方法**：データ削除SQL用意

---

## 5. 絶対に守るガードレール（チェックリスト）
- RLS必須（DBで物理拒否）
- 重要処理はServer Actionsに集約
- ユーザーへの自動送信禁止
- AIは下書きのみ、送信は人間
- Shadowは下書きのみ（送信不可）
- webhook冪等必須（LINE/Stripe）
- 監査ログ必須（改ざん不可）
- ギフト配分は売上認識ベース・税抜
- 未使用ポイントは配分対象外
- 価格変更はAdminのみ
- すべての画面はモバイル優先のレスポンシブ対応
- ユーザー認証はJWT署名付きトークン（30分有効）
- 危険検知はMVP除外（将来拡張）

---

## 6. 環境変数一覧

### 基本設定
```env
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
APP_BASE_URL=
```

### LINE連携
```env
LINE_CHANNEL_SECRET=
LINE_CHANNEL_ACCESS_TOKEN=
RICH_MENU_ID_UNCONTRACTED=
RICH_MENU_ID_CONTRACTED=
```

### ユーザー認証
```env
LINE_USER_TOKEN_SECRET=
```

### Stripe連携
```env
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
```

### AI設定
```env
AI_PROVIDER_KEY=
AI_DRAFT_DAILY_LIMIT=3
AI_TOKEN_LIMIT=
```

### SLA・運用設定
```env
SLA_WARNING_LIGHT_MINUTES=240
SLA_WARNING_STANDARD_MINUTES=120
SLA_WARNING_PREMIUM_MINUTES=30
UNREPORTED_DAYS_THRESHOLD=2
```

### トライアル設定
```env
TRIAL_PERIOD_DAYS=7
TRIAL_PLAN_CODE=standard
```

### その他
```env
DEFAULT_TAX_RATE_ID=
```

