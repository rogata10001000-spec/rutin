

---

# Rutin è¦ä»¶å®šç¾©æ›¸ï¼ˆå®Œå…¨ç‰ˆãƒ»Cursorå®Ÿè£…ç›´çµï¼‰

## 0. æ–‡æ›¸ãƒ¡ã‚¿æƒ…å ±

* æ–‡æ›¸åï¼šRutin è¦ä»¶å®šç¾©æ›¸ï¼ˆå®Œå…¨ç‰ˆï¼‰
* ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼šv1.0
* å¯¾è±¡ãƒªãƒªãƒ¼ã‚¹ï¼šMVPï¼ˆåˆæœŸãƒªãƒªãƒ¼ã‚¹ï¼‰ï¼‹å°†æ¥æ‹¡å¼µã®è¨­è¨ˆä½™åœ°ã‚’å«ã‚€
* å‰æã‚¹ã‚¿ãƒƒã‚¯ï¼ˆå¤‰æ›´ä¸å¯ï¼‰

  * Frontendï¼šNext.jsï¼ˆApp Routerï¼‰/ TypeScript / shadcn/ui + Tailwind CSS
  * Formï¼šReact Hook Form + Zod
  * Dateï¼šdate-fns
  * Tableï¼šTanStack Tableï¼ˆå¿…è¦ãªç”»é¢ã®ã¿ï¼‰
  * Backendï¼šNext.js Server Actionsï¼ˆåŸå‰‡ï¼‰ï¼‹Route Handlersï¼ˆwebhook/cron/ç®¡ç†å‡¦ç†ï¼‰
  * DBï¼šSupabase Postgres
  * Authï¼šSupabase Authï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã®ã¿ï¼‰
  * Storageï¼šSupabase Storageï¼ˆå°†æ¥ï¼‰
  * RLSï¼šå¿…é ˆï¼ˆRow Level Securityï¼‰
  * Migrationï¼šSupabase CLI migrationsé‹ç”¨
  * Observabilityï¼šSentryï¼ˆserver/clientï¼‰
  * Testï¼šPlaywrightï¼ˆE2Eï¼‰ã€Vitestï¼ˆUnit/Logicï¼‰
* å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹

  * LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆMessaging APIï¼‰
  * Stripeï¼ˆSubscription + One-time payment via Checkoutï¼‰
  * AIï¼šClaude Haiku 4.5ï¼ˆè¿”ä¿¡æ¡ˆã®ä¸‹æ›¸ãã®ã¿ï¼‰

---

# 1. ç›®çš„ãƒ»èƒŒæ™¯

## 1.1 ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

ã€Œç¶™ç¶šã§ããªã„äººã®ãŸã‚ã®ã€äººã«ã‚ˆã‚‹ä¼´èµ°å‹ãƒ»ç¿’æ…£åŒ–ã‚µãƒãƒ¼ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã€

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¯ **LINEä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿**
* **é€šè©±ãƒ»Zoomãªã—**
* **Botæ„Ÿã‚¼ãƒ­ï¼ˆæœ€é‡è¦è¦ä»¶ï¼‰**

  * è‡ªå‹•è¿”ä¿¡ãƒ»è‡ªå‹•é€ä¿¡ã¯åŸå‰‡ç¦æ­¢
  * AIã¯ä¸‹æ›¸ãè£œåŠ©ã®ã¿ï¼ˆé€ä¿¡ã¯å¿…ãšäººé–“ï¼‰

## 1.2 è§£æ±ºã™ã‚‹èª²é¡Œ

* ç¿’æ…£åŒ–ãŒè‹¦æ‰‹ãªå±¤ã®ã€Œç¶™ç¶šã§ããªã„ã€ã€Œç›¸è«‡ã§ããªã„ã€ã€Œå­¤ç‹¬ã€å•é¡Œã‚’ã€å¯¾äººä¼´èµ°ã§æ”¯ãˆã‚‹
* ã‚­ãƒ£ã‚¹ãƒˆé‹ç”¨ã‚’ç ´ç¶»ã•ã›ãšã€SLAéµå®ˆã¨å“è³ªç®¡ç†ã‚’ä¸¡ç«‹ã™ã‚‹
* åç›Šï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‹ã‚®ãƒ•ãƒˆï¼‰ã¨é‹ç”¨ï¼ˆç²¾ç®—/ç›£æŸ»ï¼‰ã‚’çŸ›ç›¾ãªãæˆç«‹ã•ã›ã‚‹

## 1.3 æˆåŠŸæ¡ä»¶ï¼ˆKPIï¼‰

* ç¶™ç¶šç‡ã®æ”¹å–„ï¼ˆä¾‹ï¼šç¿Œæœˆç¶™ç¶šç‡ã€3ãƒ¶æœˆç¶™ç¶šç‡ï¼‰
* SLAéµå®ˆç‡ï¼ˆè¿”ä¿¡SLAè¶…éã®å‰Šæ¸›ï¼‰
* ã‚­ãƒ£ã‚¹ãƒˆç¨¼åƒã®å¹³æº–åŒ–ï¼ˆInboxæ»ç•™ã‚’æ¸›ã‚‰ã™ï¼‰
* ã‚®ãƒ•ãƒˆåˆ©ç”¨ç‡ï¼ˆæŠ•ã’éŠ­å°ç·šã®åå¿œï¼‰
* å±é™ºæ¤œçŸ¥ã®è¦‹è½ã¨ã—ã‚¼ãƒ­ï¼ˆã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºå®Ÿï¼‰

---

# 2. ã‚¹ã‚³ãƒ¼ãƒ—

## 2.1 MVPã§ã€Œã‚„ã‚‹ã“ã¨ã€

### LINEé€£æº

* LINE webhookå—ä¿¡ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ/ãƒã‚¹ãƒˆãƒãƒƒã‚¯ï¼‰
* å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜ï¼ˆå†ªç­‰ï¼‰
* ç®¡ç†ç”»é¢ã‹ã‚‰LINEã¸é€ä¿¡ï¼ˆäººé–“æ“ä½œã®ã¿ï¼‰
* ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ postback ã«ã‚ˆã‚‹ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼ˆâ—¯/â–³/Ã—ï¼‰
* è‡ªå‹•è¿”ä¿¡ãªã—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸å³æ™‚ã®è‡ªå‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ã‚‰ãªã„ï¼‰

### ç®¡ç†ç”»é¢ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å‘ã‘Webï¼‰

* ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆSupabase Authï¼‰
* Inboxï¼ˆæœªè¿”ä¿¡å„ªå…ˆã€æœªå ±å‘Š2æ—¥ã€å±é™ºã‚¿ã‚°ã€pausedå„ªå…ˆåº¦ä½ä¸‹ï¼‰
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ / è©³ç´°ï¼ˆå¥‘ç´„ã‚«ãƒ¼ãƒ‰ã€å±¥æ­´ã€ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€èª•ç”Ÿæ—¥ã€ãƒ¡ãƒ¢ï¼‰
* ãƒãƒ£ãƒƒãƒˆç”»é¢ï¼ˆå·¦ï¼šå±¥æ­´ã€å³ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«/ãƒ¡ãƒ¢ï¼‰
* ä»£ç†è¿”ä¿¡ï¼ˆAdmin/Supervisorï¼‰
* ãƒ¡ãƒ¢ï¼ˆã‚«ãƒ†ã‚´ãƒªã€ãƒ”ãƒ³ã€ç·¨é›†å±¥æ­´ï¼‰
* ç›£æŸ»ãƒ­ã‚°é–²è¦§ï¼ˆAdmin/Supervisorï¼‰
* ã‚­ãƒ£ã‚¹ãƒˆæ‹…å½“å‰²å½“ï¼ˆå±¥æ­´ä¿æŒï¼‰ï¼‹Shadowï¼ˆä¸‹æ›¸ãã®ã¿ã€é€ä¿¡ä¸å¯ï¼‰

### èª²é‡‘ï¼ˆStripeï¼‰

* ã‚µãƒ–ã‚¹ã‚¯ï¼ˆLight/Standard/Premiumï¼‰
* ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹åŒæœŸï¼ˆstripe webhookï¼‰
* ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ãƒ—ãƒ©ãƒ³ä¾¡æ ¼ï¼ˆPrice overrideï¼‰
* ãƒ—ãƒ©ãƒ³å¤‰æ›´ã¯Adminã®ã¿

### AIè¿”ä¿¡æ¡ˆ

* ã€ŒAIè¿”ä¿¡æ¡ˆã€ãƒœã‚¿ãƒ³ã§3æ¡ˆç”Ÿæˆï¼ˆå…±æ„Ÿ/ç§°è³›/ææ¡ˆï¼‰
* ç›´è¿‘10ã€œ20ã‚¿ãƒ¼ãƒ³ã€ãƒ”ãƒ³ãƒ¡ãƒ¢ã€7æ—¥ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€ã‚­ãƒ£ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è¦ç´„ã‚’æ–‡è„ˆã¨ã—ã¦å…¥åŠ›
* 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1æ—¥3å›ã¾ã§
* é€ä¿¡ã¯äººé–“ã®ã¿ï¼ˆAIãŒç›´æ¥é€ã‚‰ãªã„ï¼‰

### ã‚®ãƒ•ãƒˆï¼ˆãƒã‚¤ãƒ³ãƒˆå‹ï¼šAâ€™æ¡ç”¨ï¼‰

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Stripe Checkoutã§ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ï¼ˆone-timeï¼‰
* ãƒã‚¤ãƒ³ãƒˆã§ã‚®ãƒ•ãƒˆé€ä¿¡
* **å£²ä¸Šï¼ˆèªè­˜ï¼‰ãƒ™ãƒ¼ã‚¹**ã§è¨ˆç®—

  * **ã‚®ãƒ•ãƒˆãŒè´ˆã‚‰ã‚ŒãŸç¬é–“ï¼ˆãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨ï¼‰ã«å£²ä¸Šèªè­˜**
  * ãã‚ŒãŒã‚­ãƒ£ã‚¹ãƒˆé…åˆ†ã®åˆ†æ¯ã«ãªã‚‹
  * **æœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆã¯100%é‹å–¶ã®ã‚‚ã®ï¼ˆé…åˆ†å¯¾è±¡å¤–ï¼‰**
* ã‚­ãƒ£ã‚¹ãƒˆç²¾ç®—ã¯ç¤¾å†…å ±é…¬ï¼ˆæœˆæ¬¡ï¼‰ã¨ã—ã¦è¨ˆç®—ãƒ»ãƒãƒƒãƒç¢ºå®šã§ãã‚‹
* é…åˆ†ç‡ã‚’ä¸€å¾‹/ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ã§è¨­å®šå¯èƒ½
* **ç¨æŠœãƒ™ãƒ¼ã‚¹**ã§é…åˆ†è¨ˆç®—ï¼ˆä¼šè¨ˆãŒåˆã‚ã›ã‚„ã™ã„ï¼‰

## 2.2 MVPã§ã€Œã‚„ã‚‰ãªã„ã“ã¨ã€

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è‡ªå‹•é€ä¿¡ï¼ˆãƒªãƒã‚¤ãƒ³ãƒ‰ã€è³¼å…¥å®Œäº†é€šçŸ¥ã®è‡ªå‹•ãƒˆãƒ¼ã‚¯é€ä¿¡ãªã©ï¼‰
* éŸ³å£°/é€šè©±/Zoom
* æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®é€å—ä¿¡ï¼ˆç”»åƒãƒ»PDFãªã©ï¼šå°†æ¥ï¼‰
* å¤šè¨€èª
* é«˜åº¦ãªé›¢è„±äºˆæ¸¬ã€AIã«ã‚ˆã‚‹è‡ªå‹•ä»‹å…¥
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Webãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯LINEã®ã¿ï¼‰
* **å±é™ºæ¤œçŸ¥ã®è‡ªå‹•ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¤å®š**ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ®‹ã™ãŒã€æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ã¯æœªå®Ÿè£…ï¼‰

## 2.3 å°†æ¥æ‹¡å¼µ

* æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼ˆStorageï¼‰
* ã‚®ãƒ•ãƒˆã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€é™å®šã‚®ãƒ•ãƒˆã€å­£ç¯€ã‚®ãƒ•ãƒˆ
* ã‚®ãƒ•ãƒˆã‚«ãƒ†ã‚´ãƒª/å€‹åˆ¥ã‚®ãƒ•ãƒˆã”ã¨ã®é…åˆ†ç‡
* é«˜å˜ä¾¡ã‚µãƒ–ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆã‚­ãƒ£ã‚¹ãƒˆå˜ä¾¡æˆ¦ç•¥ï¼‰
* å¤šè¨€èªå¯¾å¿œ
* é›¢è„±äºˆæ¸¬ã®é«˜åº¦åŒ–
* **å±é™ºæ¤œçŸ¥ã®è‡ªå‹•ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¤å®šãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
  * ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆç®¡ç†
  * ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«è‡ªå‹•åˆ¤å®š
  * æ–‡è„ˆåˆ¤å®šAI
  * è‡ªå‹•ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é€šçŸ¥
* ã‚­ãƒ£ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è¦ç´„ã®è‡ªå‹•æ›´æ–°ãƒ•ãƒ­ãƒ¼ï¼ˆAIç”Ÿæˆï¼‰

---

# 3. å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»åˆ©ç”¨è€…ï¼ˆå½¹å‰²ï¼‰

## 3.1 ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆLINEåˆ©ç”¨è€…ï¼‰

* ç¿’æ…£åŒ–ãŒè‹¦æ‰‹ã€å­¤ç‹¬ã€è‡ªå·±è‚¯å®šæ„Ÿä½ã‚ã€å…ˆå»¶ã°ã—ã€ç”Ÿæ´»ãƒªã‚ºãƒ å´©ã‚Œãªã©
* æ“ä½œã¯LINEã®ã¿ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ/ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼/å¿…è¦ã«å¿œã˜ã¦Webãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã‚’é–‹ãï¼‰

## 3.2 ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆç®¡ç†ç”»é¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

* Adminï¼ˆç®¡ç†è€…ï¼‰
* Supervisorï¼ˆå“è³ªç®¡ç†ãƒ»çµ±æ‹¬ï¼‰
* Castï¼ˆä¼´èµ°æ‹…å½“ï¼‰

---

# 4. ãƒ­ãƒ¼ãƒ«ãƒ»æ¨©é™ï¼ˆRBACï¼‰

## 4.1 ãƒ­ãƒ¼ãƒ«å®šç¾©

* Adminï¼šå…¨æ¨©é™ã€èª²é‡‘/ä¾¡æ ¼/æ¨©é™/ç›£æŸ»/ç²¾ç®—ç¢ºå®š
* Supervisorï¼šå“è³ªç®¡ç†ã€å…¨ä¼šè©±é–²è¦§ã€ä»£ç†è¿”ä¿¡å¯ã€å±é™ºå¯¾å¿œã€æ‹…å½“å¤‰æ›´å¯ï¼ˆé‹ç”¨ã§Adminã®ã¿ã§ã‚‚å¯ï¼‰
* Castï¼šæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿é–²è¦§ãƒ»è¿”ä¿¡ãƒ»ãƒ¡ãƒ¢ç·¨é›†ã€AIè¿”ä¿¡æ¡ˆç”Ÿæˆã€Shadowå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ä¸‹æ›¸ãä½œæˆã®ã¿ï¼ˆé€ä¿¡ä¸å¯ï¼‰

## 4.2 æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆMVPï¼‰

| æ©Ÿèƒ½          | Admin | Supervisor |               Cast |
| ----------- | ----: | ---------: | -----------------: |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ»æ¤œç´¢   |     â—‹ |          â—‹ |            â—‹ï¼ˆæ‹…å½“ã®ã¿ï¼‰ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°é–²è¦§    |     â—‹ |          â—‹ |            â—‹ï¼ˆæ‹…å½“ã®ã¿ï¼‰ |
| ãƒãƒ£ãƒƒãƒˆé–²è¦§      |     â—‹ |          â—‹ |            â—‹ï¼ˆæ‹…å½“ã®ã¿ï¼‰ |
| è¿”ä¿¡é€ä¿¡        |     â—‹ |          â—‹ |            â—‹ï¼ˆæ‹…å½“ã®ã¿ï¼‰ |
| ä»£ç†è¿”ä¿¡        |     â—‹ |          â—‹ |                  Ã— |
| ãƒ¡ãƒ¢ç·¨é›†        |     â—‹ |          â—‹ |            â—‹ï¼ˆæ‹…å½“ã®ã¿ï¼‰ |
| ãƒ¡ãƒ¢ç·¨é›†å±¥æ­´é–²è¦§    |     â—‹ |          â—‹ |            â—‹ï¼ˆæ‹…å½“ã®ã¿ï¼‰ |
| æ‹…å½“å‰²å½“/å¼•ãç¶™ã   |     â—‹ |    â—‹ï¼ˆé‹ç”¨ã§å¯ï¼‰ |                  Ã— |
| Shadowä¸‹æ›¸ãä½œæˆ |     â—‹ |          â—‹ | â—‹ï¼ˆShadowå¯¾è±¡ã®ã¿ã€é€ä¿¡ä¸å¯ï¼‰ |
| ãƒ—ãƒ©ãƒ³å¤‰æ›´       |     â—‹ |          Ã— |                  Ã— |
| ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ä¾¡æ ¼è¨­å®š   |     â—‹ |          Ã— |                  Ã— |
| ã‚®ãƒ•ãƒˆé…åˆ†ç‡è¨­å®š    |     â—‹ |          Ã— |                  Ã— |
| ç²¾ç®—ãƒãƒƒãƒä½œæˆ/ç¢ºå®š  |     â—‹ |          Ã— |                  Ã— |
| ç›£æŸ»ãƒ­ã‚°é–²è¦§      |     â—‹ |          â—‹ |              Ã—ï¼ˆåŸå‰‡ï¼‰ |

---

# 5. ãƒ—ãƒ©ãƒ³å®šç¾©ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰

## 5.1 ãƒ—ãƒ©ãƒ³ç¨®åˆ¥

* Light
* Standard
* Premium

## 5.2 ãƒ—ãƒ©ãƒ³å±æ€§ï¼ˆæ©Ÿèƒ½ãƒ»é‹ç”¨å®šç¾©ï¼‰

* `plan_code`ï¼ˆlight/standard/premiumï¼‰
* `price_monthly`ï¼ˆâ€»è¡¨ç¤ºç”¨ã€‚çœŸå®Ÿã¯Stripe Priceï¼‰
* `reply_sla_minutes`ï¼ˆä¾‹ï¼š24h/12h/2h â†’ åˆ†æ›ç®—ï¼‰
  * Light: 1440åˆ†ï¼ˆ24æ™‚é–“ï¼‰
  * Standard: 720åˆ†ï¼ˆ12æ™‚é–“ï¼‰
  * Premium: 120åˆ†ï¼ˆ2æ™‚é–“ï¼‰
* `sla_warning_minutes`ï¼ˆSLAè¶…éè­¦å‘Šã®é–¾å€¤ï¼‰
  * Light: 240åˆ†ï¼ˆæ®‹ã‚Š4æ™‚é–“ï¼‰
  * Standard: 120åˆ†ï¼ˆæ®‹ã‚Š2æ™‚é–“ï¼‰
  * Premium: 30åˆ†ï¼ˆæ®‹ã‚Š30åˆ†ï¼‰
* `daily_checkin_enabled`ï¼ˆå…¨ãƒ—ãƒ©ãƒ³trueï¼‰
* `weekly_review_enabled`ï¼ˆStandardä»¥ä¸Štrueï¼‰
* `priority_level`ï¼ˆLight=3, Standard=2, Premium=1ï¼‰
* `capacity_weight`ï¼ˆLight=1, Standard=2, Premium=4ï¼‰
* `active`

### æœªå ±å‘Šã®å®šç¾©

* ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³2æ—¥é€£ç¶šãªã—ï¼ˆ48æ™‚é–“ï¼‰
* **ã‹ã¤**ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚2æ—¥ãªã—
* â†’ Inboxä¸Šä½è¡¨ç¤º + æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆã«é€šçŸ¥

### pausedæ™‚ã®SLAé‹ç”¨

* SLAè¨ˆç®—ã‹ã‚‰é™¤å¤–ï¼ˆã‚«ã‚¦ãƒ³ãƒˆåœæ­¢ï¼‰
* Inboxå„ªå…ˆåº¦ã‚’æœ€ä¸‹ä½ã«è¨­å®š
* ãŸã ã—å±é™ºæ¤œçŸ¥ã¯ç¶™ç¶šï¼ˆå°†æ¥å®Ÿè£…ï¼‰

## 5.3 ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ãƒ—ãƒ©ãƒ³ä¾¡æ ¼ï¼ˆè¿½åŠ è¦ä»¶ï¼‰

* Planï¼ˆå†…å®¹ï¼‰ã¯å…±é€š
* Priceï¼ˆStripe Priceï¼‰ã¯

  * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¾¡æ ¼ï¼ˆplan_pricesï¼‰
  * ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ overrideï¼ˆcast_plan_price_overridesï¼‰
* ä¾¡æ ¼æ±ºå®šå„ªå…ˆé †ä½

  1. cast_plan_price_overridesï¼ˆactiveã‹ã¤æœ‰åŠ¹æœŸé–“å†…ï¼‰
  2. plan_pricesï¼ˆactiveã‹ã¤æœ‰åŠ¹æœŸé–“å†…ï¼‰

### ä¾¡æ ¼å¤‰æ›´ã®é‹ç”¨ãƒ«ãƒ¼ãƒ«

**åŸºæœ¬åŸå‰‡:**
* å€¤ä¸Šã’: **å¿…ãšæ¬¡å›æ›´æ–°ã‹ã‚‰é©ç”¨**ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿è­·ï¼‰
* å€¤ä¸‹ã’: **æ¬¡å›æ›´æ–°ã‹ã‚‰é©ç”¨**ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç°¡ç´ åŒ–ï¼‰
* ä¾‹å¤–: AdminãŒæ˜ç¤ºçš„ã«ã€Œå³æ™‚é©ç”¨ã€ã‚’é¸æŠã—ãŸå ´åˆã®ã¿

**é‹ç”¨ãƒ•ãƒ­ãƒ¼:**
1. AdminãŒä¾¡æ ¼å¤‰æ›´ã‚’è¨­å®šï¼ˆ`valid_from` = æ¬¡å›æ›´æ–°æ—¥ï¼‰
2. ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•ã§æ¬¡å›æ›´æ–°æ™‚ã«é©ç”¨
3. ç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆbefore/afterä¾¡æ ¼ã€é©ç”¨æ—¥æ™‚ï¼‰
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ã¯äººé–“ãŒæ‰‹å‹•ã§é€ã‚‹ï¼ˆBotæ„Ÿã‚¼ãƒ­ï¼‰

**ã‚­ãƒ£ã‚¹ãƒˆå¤‰æ›´æ™‚ã®ä¾¡æ ¼æŒ™å‹•:**
* **ã‚­ãƒ£ã‚¹ãƒˆãŒå¤‰ã‚ã£ã¦ã‚‚ã€å¥‘ç´„ä¸­ã®é‡‘é¡ã¯è‡ªå‹•å¤‰æ›´ã—ãªã„**
* æ–°ã‚­ãƒ£ã‚¹ãƒˆã®ä¾¡æ ¼ã¯æ¬¡å›ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ã«é©ç”¨
* ç†ç”±: å¥‘ç´„ã®å®‰å®šæ€§ã€èª¬æ˜è²¬ä»»ã®æ˜ç¢ºåŒ–
* ä¾¡æ ¼å¤‰æ›´ã¯AdminãŒæ˜ç¤ºæ“ä½œï¼ˆæ¬¡å›æ›´æ–°ã‹ã‚‰ / å³æ™‚ï¼‰ã—ã€ç›£æŸ»ãƒ­ã‚°å¿…é ˆ

**UIè¨­è¨ˆ:**
```
ä¾¡æ ¼å¤‰æ›´ç”»é¢:
[âœ“] æ¬¡å›æ›´æ–°ã‹ã‚‰é©ç”¨ï¼ˆæ¨å¥¨ï¼‰
[ ] å³æ™‚é©ç”¨ï¼ˆè¦æ³¨æ„: æ—¢å­˜å¥‘ç´„ã‚‚å¤‰æ›´ã•ã‚Œã¾ã™ï¼‰

ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°:
ã€Œã“ã®å¤‰æ›´ã¯æ¬¡å›æ›´æ–°æ—¥ï¼ˆ2026-03-01ï¼‰ã‹ã‚‰é©ç”¨ã•ã‚Œã¾ã™ã€‚
 ç¾åœ¨ã®å¥‘ç´„ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼: 15å
 å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼: 15åã€
```

---

# 6. å¥‘ç´„çŠ¶æ…‹ï¼ˆStripeåŒæœŸï¼‰

## 6.1 å¥‘ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

* `trial`
* `active`
* `past_due`
* `paused`
* `canceled`
* `incomplete`

## 6.2 çŠ¶æ…‹åˆ¥é‹ç”¨

* activeï¼šé€šå¸¸å¯¾å¿œ
* past_dueï¼šæ”¯æ‰•ã„æ¡ˆå†…ã¯ã€ŒäººåŠ›ã§é€ã‚‹ã€ï¼ˆè‡ªå‹•é€ä¿¡ãªã—ï¼‰
* pausedï¼šå—ä¿¡ã¯ç¶™ç¶šã€‚ãŸã ã—Inboxå„ªå…ˆåº¦ã‚’è½ã¨ã™ï¼ˆSLAé‹ç”¨ã‚‚ç·©ã‚ã‚‹è¡¨ç¤ºï¼‰
* canceledï¼šå¯¾å¿œçµ‚äº†ï¼ˆæ–°è¦è¿”ä¿¡ã—ãªã„é‹ç”¨ã€‚é–²è¦§ã®ã¿ã¯å¯ï¼‰
* incompleteï¼šæ±ºæ¸ˆæœªå®Œäº†ã€‚çŠ¶æ³ç¢ºèª

---

# 7. LINE UIè¨­è¨ˆï¼ˆBotæ„Ÿã‚¼ãƒ­ï¼‰

## 7.1 ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆ4åˆ†å‰²ï¼‰

* ä»Šæ—¥ã®å ±å‘Šï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³èª˜å°ï¼‰
* é€²æ—ã‚’è¦‹ã‚‹ï¼ˆå°†æ¥ï¼šWebãƒšãƒ¼ã‚¸ã§å¯è¦–åŒ–ã€‚MVPã¯ãƒªãƒ³ã‚¯ or ã€Œä½¿ã„æ–¹ã€ã«çµ±åˆã§ã‚‚å¯ï¼‰
* ç›¸è«‡ã™ã‚‹ï¼ˆãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚’ä¿ƒã™ï¼‰
* ä½¿ã„æ–¹ï¼ˆWebãƒšãƒ¼ã‚¸ã€‚ã‚®ãƒ•ãƒˆå°ç·šã‚‚ã“ã“ã«é›†ç´„ï¼‰

â€»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è‡ªå‹•è¿”ä¿¡ã¯ç¦æ­¢
â€»ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æŠ¼ä¸‹å¾Œã‚‚ã€Œè‡ªå‹•ã§è¤’ã‚ã‚‹ã€ç­‰ã¯ç¦æ­¢ã€‚ç®¡ç†ç”»é¢ã«ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã®ã¿ã€‚

## 7.2 ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼ˆpostbackï¼‰

### UIè¨­è¨ˆï¼šFlex Message

**è¡¨ç¤ºå½¢å¼:**
* LINE Flex Messageã§3ã¤ã®ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³è¡¨ç¤º
* ãƒœã‚¿ãƒ³è‰²ã§çŠ¶æ…‹ã‚’è¦–è¦šåŒ–
  * â—¯ è‰¯ã„ï¼ˆç·‘ #00C300ï¼‰
  * â–³ æ™®é€šï¼ˆé»„ #FFB800ï¼‰
  * Ã— æ‚ªã„ï¼ˆèµ¤ #FF4444ï¼‰

**postbackãƒ‡ãƒ¼ã‚¿ä»•æ§˜ï¼ˆMVPå›ºå®šï¼‰:**
* `action=checkin`
* `status=circle|triangle|cross`
* `date=YYYY-MM-DD`ï¼ˆJSTæ—¥ä»˜ã€‚LINEå´ã§æ¸¡ã›ãªã„å ´åˆã¯ã‚µãƒ¼ãƒã§å—ä¿¡æ™‚ã«JSTæ›ç®—ã—ã¦è£œå®Œï¼‰

**é¸æŠå¾Œã®æŒ™å‹•:**
1. postbackå—ä¿¡ â†’ DBè¨˜éŒ²ï¼ˆ`checkins` upsert: åŒæ—¥ã¯ä¸Šæ›¸ãï¼‰
2. LINEã¸ã®è‡ªå‹•è¿”ä¿¡: **ãªã—**ï¼ˆBotæ„Ÿã‚¼ãƒ­ï¼‰
3. ç®¡ç†ç”»é¢: Inboxã«ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã€ã¨ã—ã¦è¡¨ç¤º
4. ã‚­ãƒ£ã‚¹ãƒˆãŒè‡ªç„¶ã«åå¿œ: ã€Œä»Šæ—¥ã¯â–³ã ã£ãŸã‚“ã§ã™ã­ã€

**è¤‡æ•°å›æŠ¼ä¸‹æ™‚ã®æŒ™å‹•:**
* åŒæ—¥ã¯ä¸Šæ›¸ãï¼ˆæœ€æ–°ã‚’æ¡ç”¨ï¼‰
* ç†ç”±: æ°—åˆ†ã®å¤‰åŒ–ã‚’åæ˜ ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç”±åº¦ã‚’å„ªå…ˆ

**Flex Message JSONãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¾‹:**
```json
{
  "type": "flex",
  "altText": "ä»Šæ—¥ã®èª¿å­ã¯ã©ã†ã§ã™ã‹ï¼Ÿ",
  "contents": {
    "type": "bubble",
    "body": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "text",
          "text": "ä»Šæ—¥ã®èª¿å­ã¯ï¼Ÿ",
          "weight": "bold",
          "size": "lg"
        },
        {
          "type": "box",
          "layout": "horizontal",
          "spacing": "sm",
          "contents": [
            {
              "type": "button",
              "action": {
                "type": "postback",
                "label": "â—¯ è‰¯ã„",
                "data": "action=checkin&status=circle&date=2026-02-03"
              },
              "style": "primary",
              "color": "#00C300"
            },
            {
              "type": "button",
              "action": {
                "type": "postback",
                "label": "â–³ æ™®é€š",
                "data": "action=checkin&status=triangle&date=2026-02-03"
              },
              "style": "primary",
              "color": "#FFB800"
            },
            {
              "type": "button",
              "action": {
                "type": "postback",
                "label": "Ã— æ‚ªã„",
                "data": "action=checkin&status=cross&date=2026-02-03"
              },
              "style": "primary",
              "color": "#FF4444"
            }
          ]
        }
      ]
    }
  }
}
```

## 7.3 ã‚®ãƒ•ãƒˆå°ç·šï¼ˆBotæ„Ÿã‚¼ãƒ­ç¶­æŒï¼‰

* è‡ªå‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å°ç·šã‚’å‡ºã•ãªã„
* ã€Œä½¿ã„æ–¹ã€ãƒšãƒ¼ã‚¸ï¼ˆWebï¼‰å†…ã«

  * ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ï¼ˆStripe Checkoutã¸é·ç§»ï¼‰
  * ã‚®ãƒ•ãƒˆé€ä¿¡ï¼ˆWebä¸Šãƒœã‚¿ãƒ³ â†’ ã‚µãƒ¼ãƒå‡¦ç†ï¼‰
  * æ®‹ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
* ã‚®ãƒ•ãƒˆé€ä¿¡å¾Œ

  * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸è‡ªå‹•ãƒˆãƒ¼ã‚¯é€ä¿¡ã—ãªã„
  * ä»£ã‚ã‚Šã«ã€Œä¼šè©±å±¥æ­´ï¼ˆç®¡ç†ç”»é¢ï¼‰ã€ã«ğŸã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦è¨˜éŒ²ã—ã€ã‚­ãƒ£ã‚¹ãƒˆãŒè‡ªç„¶ã«åå¿œã§ãã‚‹

## 7.4 ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘Webãƒšãƒ¼ã‚¸èªè¨¼

### èªè¨¼æ–¹å¼ï¼šJWTç½²åä»˜ãä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³

**æ¦‚è¦:**
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯LINEã‹ã‚‰ç›´æ¥Webãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãªã—ï¼‰
* URLã«JWTç½²åä»˜ããƒˆãƒ¼ã‚¯ãƒ³ã‚’åŸ‹ã‚è¾¼ã¿ã€ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œè¨¼
* ãƒˆãƒ¼ã‚¯ãƒ³ã¯30åˆ†é–“æœ‰åŠ¹ï¼ˆçŸ­æ™‚é–“ã§å®Œçµã™ã‚‹æ“ä½œã‚’æƒ³å®šï¼‰

**ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰:**
```typescript
const token = jwt.sign(
  { 
    line_user_id: 'U1234567890abcdef',
    exp: Math.floor(Date.now() / 1000) + (60 * 30) // 30åˆ†æœ‰åŠ¹
  },
  process.env.LINE_USER_TOKEN_SECRET
);
```

**URLå½¢å¼:**
```
https://your-domain.com/subscribe/cast?token=SIGNED_TOKEN
https://your-domain.com/points?token=SIGNED_TOKEN
https://your-domain.com/gift?token=SIGNED_TOKEN
```

**ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰:**
```typescript
// Server Actionå†…ã§æ¤œè¨¼
const decoded = jwt.verify(token, process.env.LINE_USER_TOKEN_SECRET);
const lineUserId = decoded.line_user_id;
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–:**
* ç½²åã«ã‚ˆã‚Šæ”¹ã–ã‚“é˜²æ­¢
* æœ‰åŠ¹æœŸé™ï¼ˆ30åˆ†ï¼‰ã§æ¼æ´©ãƒªã‚¹ã‚¯è»½æ¸›
* HTTPSå¿…é ˆ
* ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä½¿ã„æ¨ã¦ï¼ˆå†åˆ©ç”¨ä¸å¯ï¼‰

**é‹ç”¨ãƒ•ãƒ­ãƒ¼:**
1. LINEãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®URLã«äº‹å‰ç”Ÿæˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’åŸ‹ã‚è¾¼ã‚€
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¿ãƒƒãƒ— â†’ Webãƒšãƒ¼ã‚¸ã¸é·ç§»
3. ã‚µãƒ¼ãƒãƒ¼ãŒãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ â†’ line_user_idå–å¾—
4. æ“ä½œå®Œäº†å¾Œã€LINEã‚¢ãƒ—ãƒªã¸æˆ»ã‚‹å°ç·šã‚’è¡¨ç¤º

---

# 8. ç®¡ç†ç”»é¢ æ©Ÿèƒ½è¦ä»¶

## 8.1 ç”»é¢ä¸€è¦§ï¼ˆMVPï¼‰

1. ãƒ­ã‚°ã‚¤ãƒ³
2. Inbox
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°
5. ãƒãƒ£ãƒƒãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ï¼‰
6. ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ï¼ˆAdminï¼‰
7. ä¾¡æ ¼ç®¡ç†ï¼ˆAdminï¼šã‚­ãƒ£ã‚¹ãƒˆåˆ¥ãƒ—ãƒ©ãƒ³ä¾¡æ ¼ï¼‰
8. ã‚®ãƒ•ãƒˆç®¡ç†ï¼ˆAdminï¼šã‚®ãƒ•ãƒˆã‚«ã‚¿ãƒ­ã‚°ã€ãƒã‚¤ãƒ³ãƒˆå•†å“ï¼‰
9. é…åˆ†ãƒ«ãƒ¼ãƒ«ç®¡ç†ï¼ˆAdminï¼‰
10. ç²¾ç®—ï¼ˆAdminï¼šæœˆæ¬¡ãƒãƒƒãƒï¼‰
11. ç›£æŸ»ãƒ­ã‚°ï¼ˆAdmin/Supervisorï¼‰

## 8.2 Inbox

### è¡¨ç¤ºé …ç›®

* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
* ãƒ—ãƒ©ãƒ³ï¼ˆè‰²ãƒãƒƒã‚¸ï¼‰
* å¥‘ç´„çŠ¶æ…‹ï¼ˆãƒãƒƒã‚¸ï¼‰
* æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆ
* æ¬¡å›æ›´æ–°æ—¥
* æœªè¿”ä¿¡æ™‚é–“ï¼ˆåˆ†/æ™‚é–“è¡¨ç¤ºï¼‰
* ã‚¿ã‚°ï¼ˆğŸ‚ğŸ’³âš ï¸ ç­‰ï¼‰
* å„ªå…ˆåº¦ï¼ˆè¨ˆç®—çµæœï¼šSLAæ®‹ã‚Šã€å±é™ºã€æœªå ±å‘Šã€pausedãƒšãƒŠãƒ«ãƒ†ã‚£ç­‰ï¼‰

### ã‚½ãƒ¼ãƒˆ/ãƒ•ã‚£ãƒ«ã‚¿

* æœªè¿”ä¿¡å„ªå…ˆ
* å±é™ºãƒ•ãƒ©ã‚°å„ªå…ˆ
* æœªå ±å‘Š2æ—¥ä»¥ä¸Š
* pausedã¯å„ªå…ˆåº¦ã‚’ä¸‹ã’ã‚‹ï¼ˆãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰
* ãƒ—ãƒ©ãƒ³ã€å¥‘ç´„çŠ¶æ…‹ã€æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆã€ã‚¿ã‚°ã§ãƒ•ã‚£ãƒ«ã‚¿

## 8.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§

* æ¤œç´¢ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ã‚¿ã‚°ï¼‰
* ä¸€è¦§é …ç›®ã¯Inboxã¨æ¦‚ã­åŒç­‰ï¼ˆæœªè¿”ä¿¡æ™‚é–“å«ã‚€ï¼‰

## 8.4 ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°

* å¥‘ç´„ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ—ãƒ©ãƒ³ãƒ»çŠ¶æ…‹ãƒ»æ›´æ–°æ—¥ãƒ»Stripeå‚ç…§IDï¼‰
* ãƒãƒ£ãƒƒãƒˆå±¥æ­´
* ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ï¼ˆç›´è¿‘7æ—¥/30æ—¥ï¼‰
* èª•ç”Ÿæ—¥è¡¨ç¤ºï¼ˆå½“æ—¥å¼·èª¿ï¼‰
* å†…éƒ¨ãƒ¡ãƒ¢ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ»ãƒ”ãƒ³ï¼‰
* ã‚®ãƒ•ãƒˆ/ãƒã‚¤ãƒ³ãƒˆ

  * æ®‹ãƒã‚¤ãƒ³ãƒˆ
  * ã‚®ãƒ•ãƒˆå±¥æ­´
  * å£²ä¸Šèªè­˜ï¼ˆgift_redeemï¼‰å±¥æ­´ï¼ˆç¨æŠœãƒ»ç¨é¡ãƒ»ç¨è¾¼ã®å†…è¨³è¡¨ç¤ºï¼‰

## 8.5 ãƒãƒ£ãƒƒãƒˆç”»é¢

* å·¦ï¼šä¼šè©±å±¥æ­´ï¼ˆin/outï¼‰
* å³ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ï¼‹ãƒ¡ãƒ¢
* æ©Ÿèƒ½

  * è¿”ä¿¡é€ä¿¡ï¼ˆäººåŠ›ï¼‰
  * ä»£ç†è¿”ä¿¡ãƒ¢ãƒ¼ãƒ‰ï¼ˆAdmin/Supervisorï¼‰
  * AIè¿”ä¿¡æ¡ˆï¼ˆ3æ¡ˆï¼‰
  * Shadowä¸‹æ›¸ãï¼ˆShadowå¯¾è±¡ã®Castã®ã¿ã€é€ä¿¡ä¸å¯ï¼‰
  * ã‚®ãƒ•ãƒˆã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºï¼ˆğŸï¼‰

## 8.6 ãƒ¡ãƒ¢æ©Ÿèƒ½

* ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« / NG / åˆºã•ã‚‹è¨€è‘‰ ç­‰ï¼‰
* ãƒ”ãƒ³ç•™ã‚
* ç·¨é›†å±¥æ­´ä¿æŒï¼ˆèª°ãŒ/ã„ã¤/å†…å®¹ï¼‰

## 8.7 èª•ç”Ÿæ—¥æ©Ÿèƒ½

* èª•ç”Ÿæ—¥è¡¨ç¤º
* å½“æ—¥å¼·èª¿
* ãŠç¥ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒœã‚¿ãƒ³ï¼ˆæŠ¼ã™ã¨è¿”ä¿¡æ¬„ã¸æŒ¿å…¥ï¼‰
* é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°ï¼ˆåŒå¹´åŒæ—¥ã§é‡è¤‡é€ä¿¡é˜²æ­¢ï¼‰

## 8.8 ä»£ç†è¿”ä¿¡ï¼ˆAdmin/Supervisorï¼‰

### åŸºæœ¬æ©Ÿèƒ½

* ä»£ç†è¿”ä¿¡ãƒ¢ãƒ¼ãƒ‰ã§é€ä¿¡
* ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
* æœ¬æ¥æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆã¸é€šçŸ¥ï¼ˆç®¡ç†ç”»é¢å†…é€šçŸ¥ã§OKã€å¤–éƒ¨é€šçŸ¥ã¯å°†æ¥ï¼‰
* ä»£ç†è¿”ä¿¡ã§ã‚ã‚‹ã“ã¨ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã—ãªã„ï¼ˆBotæ„Ÿã‚¼ãƒ­ï¼†é‹ç”¨ä¸Šã‚‚å†…éƒ¨ã®ã¿ï¼‰

### å…·ä½“çš„ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹1: ç·Šæ€¥å¯¾å¿œ**
* ã‚·ãƒ¼ãƒ³: å±é™ºæ¤œçŸ¥ãƒ¬ãƒ™ãƒ«1ãŒç™ºç”Ÿã€æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆä¸åœ¨ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
* å¯¾å¿œè€…: Supervisor
* æœŸé™: 1æ™‚é–“ä»¥å†…
* é€šçŸ¥: æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆã¸Slack/ç®¡ç†ç”»é¢é€šçŸ¥

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹2: å¼•ãç¶™ãæœŸé–“**
* ã‚·ãƒ¼ãƒ³: ã‚­ãƒ£ã‚¹ãƒˆå¤‰æ›´ç›´å¾Œã®ç§»è¡ŒæœŸé–“ï¼ˆ1é€±é–“ï¼‰
* å¯¾å¿œè€…: å‰ä»»ã‚­ãƒ£ã‚¹ãƒˆ or Supervisor
* ç†ç”±: æ–°ã‚­ãƒ£ã‚¹ãƒˆãŒæ–‡è„ˆã‚’æŠŠæ¡ã™ã‚‹ã¾ã§ã®ã‚µãƒãƒ¼ãƒˆ
* é€šçŸ¥: æ–°ã‚­ãƒ£ã‚¹ãƒˆã¸ã€Œä»£ç†è¿”ä¿¡ã—ã¾ã—ãŸã€

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹3: ç ”ä¿®ãƒ»å“è³ªç®¡ç†**
* ã‚·ãƒ¼ãƒ³: æ–°äººã‚­ãƒ£ã‚¹ãƒˆã®è¿”ä¿¡å“è³ªãƒã‚§ãƒƒã‚¯
* å¯¾å¿œè€…: Supervisor
* æ–¹æ³•:
  1. æ–°äººãŒä¸‹æ›¸ãä½œæˆ
  2. SupervisorãŒãƒ¬ãƒ“ãƒ¥ãƒ¼
  3. å•é¡Œã‚ã‚Œã°ä»£ç†è¿”ä¿¡ + ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

### é »åº¦åˆ¶é™

* ãªã—ï¼ˆå¿…è¦ã«å¿œã˜ã¦ä½¿ç”¨ï¼‰
* ãŸã ã—ç›£æŸ»ãƒ­ã‚°ã§è¿½è·¡ã€æœˆæ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å‚¾å‘åˆ†æ

### é€šçŸ¥æ–¹æ³•

```
ç®¡ç†ç”»é¢å†…é€šçŸ¥:
ã€Œ[ä»£ç†è¿”ä¿¡] Supervisorç”°ä¸­ã•ã‚“ãŒã€ã‚ãªãŸã®æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼å±±ç”°ã•ã‚“ã¸è¿”ä¿¡ã—ã¾ã—ãŸã€‚
 ç†ç”±: ç·Šæ€¥å¯¾å¿œï¼ˆå±é™ºæ¤œçŸ¥ï¼‰
 å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã€
```

### é‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

**âœ“ ä½¿ã†ã¹ãæ™‚:**
* å±é™ºæ¤œçŸ¥ã§æ‹…å½“ä¸åœ¨ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
* SLAè¶…éè¦‹è¾¼ã¿ã§æ‹…å½“é€£çµ¡å–ã‚Œãš
* æ–°äººç ”ä¿®ã§ã®å“è³ªãƒã‚§ãƒƒã‚¯

**âœ— ä½¿ã‚ãªã„æ–¹ãŒè‰¯ã„æ™‚:**
* æ‹…å½“ãŒå˜ã«å¿™ã—ã„ï¼ˆSLAå†…ãªã‚‰å¾…ã¤ï¼‰
* å€‹äººçš„ãªå¥½ã¿ã§å†…å®¹ã‚’å¤‰ãˆãŸã„
* æ‹…å½“ã«ç›¸è«‡ã›ãšå‹æ‰‹ã«ä»‹å…¥

---

# 9. AIè¿”ä¿¡æ¡ˆï¼ˆä¸‹æ›¸ãè£œåŠ©ã®ã¿ï¼‰

## 9.1 æ©Ÿèƒ½

* ã€ŒAIè¿”ä¿¡æ¡ˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§ç”Ÿæˆ
* 3æ¡ˆç”Ÿæˆï¼ˆå…±æ„Ÿ / ç§°è³› / ææ¡ˆï¼‰
* é€ä¿¡ã¯å¿…ãšäººé–“ãŒè¡Œã†ï¼ˆAIã¯é€ã‚‰ãªã„ï¼‰

## 9.2 å…¥åŠ›æ–‡è„ˆ

* ç›´è¿‘10ã€œ20ã‚¿ãƒ¼ãƒ³
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¢ï¼ˆãƒ”ãƒ³ã®ã¿ï¼‰
* ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å±¥æ­´ï¼ˆç›´è¿‘7æ—¥ï¼‰
* ã‚­ãƒ£ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è¦ç´„ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰

## 9.3 åˆ¶é™

* 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1æ—¥3å›ã¾ã§ï¼ˆJSTæ—¥ä»˜ï¼‰
* ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™ï¼ˆè¨­å®šå€¤ã¨ã—ã¦ç’°å¢ƒå¤‰æ•°ç®¡ç†ï¼‰
* å¤±æ•—æ™‚ã¯ç†ç”±ã‚’å†…éƒ¨è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸è‡ªå‹•é€ä¿¡ã—ãªã„ï¼‰

## 9.4 ã‚­ãƒ£ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è¦ç´„

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

* `staff_profiles.style_summary text null`
* `staff_profiles.style_updated_at timestamptz null`

### åˆæœŸä½œæˆæ–¹æ³•

1. ã‚­ãƒ£ã‚¹ãƒˆæœ¬äººãŒè¨˜å…¥ï¼ˆ200-300æ–‡å­—ï¼‰
2. SupervisorãŒãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èª
3. ä¾‹: ã€Œæ˜ã‚‹ãå‰å‘ããªè¨€è‘‰é¸ã³ã‚’å¿ƒãŒã‘ã¦ã„ã¾ã™ã€‚çµµæ–‡å­—ã¯é©åº¦ã«ä½¿ç”¨ã€‚å…±æ„Ÿã‚’å¤§åˆ‡ã«ã€æŠ¼ã—ä»˜ã‘ãªã„ææ¡ˆã‚’æ„è­˜ã€‚ã€

### æ›´æ–°ãƒ•ãƒ­ãƒ¼

* é »åº¦: 3ãƒ¶æœˆã«1å›ï¼ˆå››åŠæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
* æ–¹æ³•: ã‚­ãƒ£ã‚¹ãƒˆæœ¬äºº or SupervisorãŒç·¨é›†
* ãƒˆãƒªã‚¬ãƒ¼:
  * å®šæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚
  * å¤§ããªã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´æ™‚
  * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§æŒ‡æ‘˜æ™‚

### AIè¿”ä¿¡æ¡ˆã§ã®åˆ©ç”¨

```typescript
const context = {
  recentMessages: last20Messages,
  pinnedMemos: pinnedMemos,
  checkins: last7DaysCheckins,
  castStyle: cast.style_summary // â† ã“ã“ã§å‚ç…§
};
```

### ç·¨é›†æ¨©é™

* ã‚­ãƒ£ã‚¹ãƒˆæœ¬äºº: è‡ªåˆ†ã®ã‚¹ã‚¿ã‚¤ãƒ«è¦ç´„ã‚’ç·¨é›†å¯
* Supervisor: å…¨ã‚­ãƒ£ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«è¦ç´„ã‚’ç·¨é›†å¯
* Admin: å…¨ã‚­ãƒ£ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«è¦ç´„ã‚’ç·¨é›†å¯

### å°†æ¥æ‹¡å¼µ

* å®Ÿè¿”ä¿¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰AIè‡ªå‹•ç”Ÿæˆ
* A/Bãƒ†ã‚¹ãƒˆã§åŠ¹æœæ¸¬å®š

---

# 10. ã‚­ãƒ£ã‚¹ãƒˆé‹ç”¨è¨­è¨ˆ

## 10.1 æ‹…å½“ï¼ˆå›ºå®šï¼‰

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ **åŸå‰‡1äººã®æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆ**
* å¼•ãç¶™ãã¯å±¥æ­´ã‚’æ®‹ã—ã¦å¤‰æ›´ï¼ˆcast_assignmentsï¼‰
* æ‹…å½“å¤‰æ›´ã¯Adminã¾ãŸã¯Supervisorï¼ˆé‹ç”¨ã§çµã£ã¦ã‚‚è‰¯ã„ï¼‰

## 10.2 Shadowï¼ˆå®‰å…¨è¨­è¨ˆï¼‰

* Shadowã¯ **ä¸‹æ›¸ãOKãƒ»é€ä¿¡ä¸å¯**
* ShadowæœŸé–“ã¯ `shadow_until` ã§ç®¡ç†
* Shadow castã¯

  * é–²è¦§ï¼šå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šè©±é–²è¦§å¯
  * ä½œæˆï¼šä¸‹æ›¸ãã®ã¿ï¼ˆshadow_draftsï¼‰
  * é€ä¿¡ï¼šä¸å¯ï¼ˆRLS + ã‚µãƒ¼ãƒæ¨©é™ãƒã‚§ãƒƒã‚¯ã§ç‰©ç†é˜²æ­¢ï¼‰

## 10.3 Inboxé‹ç”¨

* æœªè¿”ä¿¡å„ªå…ˆ
* æœªå ±å‘Š2æ—¥ä»¥ä¸Šã‚’å„ªå…ˆ
* å±é™ºã‚¿ã‚°ã¯æœ€å„ªå…ˆã§Supervisor/Adminã¸ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
* pausedã¯å„ªå…ˆåº¦ã‚’è½ã¨ã™ï¼ˆé‹ç”¨è² è·è»½æ¸›ï¼‰

## 10.4 æ‹…å½“ä¸Šé™ï¼ˆcapacity_weightï¼‰

* å„ã‚­ãƒ£ã‚¹ãƒˆã« `capacity_limit`ï¼ˆé‹ç”¨å€¤ï¼‰ã‚’è¨­å®š
* æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°Ã—plan.capacity_weight ã®åˆè¨ˆãŒä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†å‰²å½“æ”¯æ´ï¼ˆMVPã¯è­¦å‘Šè¡¨ç¤ºï¼‰

---

# 11. è‡ªå‹•åŒ–ï¼ˆè£å´ã®ã¿ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸è‡ªå‹•é€ä¿¡ãªã—ï¼‰

## 11.1 è£å´ã‚¢ãƒ©ãƒ¼ãƒˆ

* æœªè¿”ä¿¡ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆSLAè¶…éè¦‹è¾¼ã¿/è¶…éï¼‰
* æœªå ±å‘Šæ¤œçŸ¥ï¼ˆ2æ—¥ä»¥ä¸Šãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãªã—ç­‰ï¼‰
* å±é™ºãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ï¼ˆãƒªã‚¹ã‚¯ãƒ•ãƒ©ã‚°ï¼‰
* ãƒ†ãƒ³ãƒ—ãƒ¬æç¤ºï¼ˆç®¡ç†ç”»é¢ã«å€™è£œã‚’å‡ºã™ã ã‘ï¼‰

## 11.2 å±é™ºæ¤œçŸ¥ï¼ˆå°†æ¥æ‹¡å¼µãƒ»MVPé™¤å¤–ï¼‰

**MVPã§ã¯å®Ÿè£…ã—ãªã„:**
* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯
* è‡ªå‹•ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
* ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¤å®š

**MVPã§æ®‹ã™ã‚‚ã®ï¼ˆæœ€å°é™ã‚¹ã‚¿ãƒ–ï¼‰:**
* `risk_flags` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå°†æ¥ã®ãŸã‚ï¼‰
* ç®¡ç†ç”»é¢ã§ã®risk_flagsè¡¨ç¤ºUIï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¡¨ç¤ºï¼‰

**å°†æ¥å®Ÿè£…æ™‚ã®è¨­è¨ˆ:**
* æ¤œçŸ¥ã—ãŸã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã¯ä½•ã‚‚ã—ãªã„
* ç®¡ç†ç”»é¢ã§ `risk_flags` ã‚’ä½œæˆã—ã€Inboxä¸Šä½è¡¨ç¤º
* ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…ˆï¼š**Admin + Supervisor**
* å¯¾å¿œãƒ•ãƒ­ãƒ¼ï¼ˆé‹ç”¨ï¼‰
  * SupervisorãŒä¸€æ¬¡ç¢ºèª â†’ å¿…è¦ãªã‚‰ä»£ç†è¿”ä¿¡/å¯¾å¿œæ–¹é‡æ±ºå®š
  * ãƒ†ãƒ³ãƒ—ãƒ¬å€™è£œã‚’è¡¨ç¤ºï¼ˆäººé–“ãŒé€ã‚‹ï¼‰

---

# 12. ã‚®ãƒ•ãƒˆï¼ˆãƒã‚¤ãƒ³ãƒˆå‹ Aâ€™ï¼‰è¦ä»¶å®šç¾©ï¼ˆæœ€é‡è¦ï¼šçµŒç†ã¨æ•´åˆï¼‰

## 12.1 æ¦‚è¦

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Stripeã§ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ï¼ˆone-timeï¼‰
* ãƒã‚¤ãƒ³ãƒˆã§ã‚®ãƒ•ãƒˆé€ä¿¡
* **å£²ä¸Šèªè­˜ã¯ã€Œã‚®ãƒ•ãƒˆé€ä¿¡ï¼ˆãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨ï¼‰ã€æ™‚ç‚¹**
* ã‚­ãƒ£ã‚¹ãƒˆé…åˆ†ã®åˆ†æ¯ã¯ **èªè­˜ã•ã‚ŒãŸã‚®ãƒ•ãƒˆå£²ä¸Šï¼ˆç¨æŠœï¼‰**
* æœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆã¯é…åˆ†å¯¾è±¡å¤–ï¼ˆé‹å–¶100%ï¼‰

## 12.2 åŸºæœ¬ãƒ«ãƒ¼ãƒ«ï¼ˆå›ºå®šï¼‰

* ãƒã‚¤ãƒ³ãƒˆå˜ä½ï¼š`pt`
* æ›ç®—ï¼š**1pt = 1å††ï¼ˆç¨æŠœã®åŸºæº–å€¤ã¨ã—ã¦æ‰±ã†ï¼‰**
* ã‚®ãƒ•ãƒˆã‚³ã‚¹ãƒˆï¼š`cost_points`ï¼ˆptï¼‰
* ã‚®ãƒ•ãƒˆé€ä¿¡æ™‚ï¼ˆredeemï¼‰

  * å£²ä¸Šï¼ˆç¨æŠœï¼‰= `cost_points` å††
  * æ¶ˆè²»ç¨ = ç¨ç‡ï¼ˆè¨­å®šå€¤ï¼‰ã«åŸºã¥ãè¨ˆç®—
  * ç¨è¾¼ = ç¨æŠœ + ç¨
* æœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆ

  * é…åˆ†å¯¾è±¡å¤–
  * ä¼šè¨ˆä¸Šã®æ‰±ã„ï¼ˆè² å‚µã¨ã—ã¦æ®‹ã™ï¼æœŸé™ã§ãƒ–ãƒ¬ã‚¤ã‚¯ï¼‰ã¯å°†æ¥ãƒãƒªã‚·ãƒ¼ã§è¨­å®šå¯èƒ½ã«ã™ã‚‹ãŒã€MVPã§ã¯ã€ŒæœŸé™ãªã—ã€ã§ã‚‚æˆç«‹ã™ã‚‹è¨­è¨ˆã¨ã™ã‚‹

## 12.3 ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ï¼ˆStripe Checkoutï¼‰

* One-time paymentï¼ˆCheckoutï¼‰
* è³¼å…¥å•†å“ï¼špoint_products
* è³¼å…¥å®Œäº†é€šçŸ¥ã‚’LINEãƒˆãƒ¼ã‚¯ã«è‡ªå‹•é€ä¿¡ã—ãªã„
* Webï¼ˆä½¿ã„æ–¹ãƒšãƒ¼ã‚¸ï¼‰ã§è³¼å…¥å®Œäº†ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹

### ãƒã‚¤ãƒ³ãƒˆå•†å“ã®ä¾¡æ ¼è¨­å®šï¼ˆMVPåˆæœŸãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ï¼‰

| å•†å“å | ãƒã‚¤ãƒ³ãƒˆæ•° | ç¨æŠœä¾¡æ ¼ | ç¨è¾¼ä¾¡æ ¼ | ãŠå¾—åº¦ | Stripe Price ID |
|--------|-----------|---------|---------|--------|-----------------|
| 1,000ãƒã‚¤ãƒ³ãƒˆ | 1,000pt | Â¥1,000 | Â¥1,100 | - | price_xxx1 |
| 3,000ãƒã‚¤ãƒ³ãƒˆ | 3,000pt | Â¥2,800 | Â¥3,080 | 7%ãŠå¾— | price_xxx2 |
| 5,000ãƒã‚¤ãƒ³ãƒˆ | 5,000pt | Â¥4,500 | Â¥4,950 | 10%ãŠå¾— | price_xxx3 |
| 10,000ãƒã‚¤ãƒ³ãƒˆ | 10,000pt | Â¥8,500 | Â¥9,350 | 15%ãŠå¾— | price_xxx4 |

**è¨­è¨ˆæ„å›³:**
* å°‘é¡ã‹ã‚‰è³¼å…¥å¯èƒ½ï¼ˆå¿ƒç†çš„ãƒãƒ¼ãƒ‰ãƒ«ä½æ¸›ï¼‰
* ã¾ã¨ã‚è²·ã„ã§ãŠå¾—æ„Ÿï¼ˆå¤§å£è³¼å…¥ä¿ƒé€²ï¼‰
* ç¨ç‡10%ã§è¨ˆç®—ï¼ˆå°†æ¥ã®ç¨ç‡å¤‰æ›´ã«å¯¾å¿œå¯èƒ½ï¼‰

## 12.4 ã‚®ãƒ•ãƒˆé€ä¿¡

* ã‚®ãƒ•ãƒˆä¸€è¦§ï¼ˆgift_catalogï¼‰
* ã‚®ãƒ•ãƒˆé€ä¿¡ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œï¼ˆWebãƒšãƒ¼ã‚¸ï¼‰ã§è¡Œã†
* ã‚®ãƒ•ãƒˆé€ä¿¡å¾Œ

  * è‡ªå‹•ã§LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãªã„
  * ç®¡ç†ç”»é¢å´ã®ä¼šè©±å±¥æ­´ã«ğŸã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²ï¼ˆcastãŒè‡ªç„¶ã«è¿”ä¿¡ï¼‰

### ã‚®ãƒ•ãƒˆã‚«ã‚¿ãƒ­ã‚°ï¼ˆMVPåˆæœŸãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ï¼‰

**ã‚«ãƒ†ã‚´ãƒª1: æ„Ÿè¬ï¼ˆä½ä¾¡æ ¼å¸¯ï¼‰**

| ã‚®ãƒ•ãƒˆå | ã‚¢ã‚¤ã‚³ãƒ³ | ã‚³ã‚¹ãƒˆ | ã‚«ãƒ†ã‚´ãƒª | èª¬æ˜ |
|---------|---------|--------|---------|------|
| ã‚³ãƒ¼ãƒ’ãƒ¼1æ¯ | â˜• | 300pt | æ„Ÿè¬ | æ°—è»½ã«æ„Ÿè¬ã‚’ä¼ãˆã‚‹ |
| ã‚±ãƒ¼ã‚­ | ğŸ° | 500pt | æ„Ÿè¬ | ã¡ã‚‡ã£ã¨ã—ãŸå¾¡ç¤¼ã« |
| ãŠèŠ± | ğŸŒ¸ | 800pt | æ„Ÿè¬ | ç‰¹åˆ¥ãªæ„Ÿè¬ã®æ°—æŒã¡ |

**ã‚«ãƒ†ã‚´ãƒª2: å¿œæ´ï¼ˆä¸­ä¾¡æ ¼å¸¯ï¼‰**

| ã‚®ãƒ•ãƒˆå | ã‚¢ã‚¤ã‚³ãƒ³ | ã‚³ã‚¹ãƒˆ | ã‚«ãƒ†ã‚´ãƒª | èª¬æ˜ |
|---------|---------|--------|---------|------|
| æœ¬1å†Š | ğŸ“š | 1,500pt | å¿œæ´ | å­¦ã³ã‚’å¿œæ´ |
| æ˜ ç”»ãƒã‚±ãƒƒãƒˆ | ğŸ¬ | 2,000pt | å¿œæ´ | ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’å¿œæ´ |
| ãƒ©ãƒ³ãƒ | ğŸ± | 1,000pt | å¿œæ´ | æ—¥ã€…ã®å¿œæ´ |

**ã‚«ãƒ†ã‚´ãƒª3: ç‰¹åˆ¥ï¼ˆé«˜ä¾¡æ ¼å¸¯ï¼‰**

| ã‚®ãƒ•ãƒˆå | ã‚¢ã‚¤ã‚³ãƒ³ | ã‚³ã‚¹ãƒˆ | ã‚«ãƒ†ã‚´ãƒª | èª¬æ˜ |
|---------|---------|--------|---------|------|
| ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ | ğŸ | 5,000pt | ç‰¹åˆ¥ | ç‰¹åˆ¥ãªæ„Ÿè¬ |
| ã‚¹ãƒšã‚·ãƒ£ãƒ« | âœ¨ | 10,000pt | ç‰¹åˆ¥ | æœ€é«˜ã®æ„Ÿè¬ |

**è¨­è¨ˆæ„å›³:**
* å¿ƒç†çš„ãƒãƒ¼ãƒ‰ãƒ«: 300å††ã‹ã‚‰æ°—è»½ã«é€ã‚Œã‚‹
* æ®µéšçš„: é–¢ä¿‚æ€§ã«å¿œã˜ã¦é¸ã¹ã‚‹ä¾¡æ ¼å¸¯
* å…·ä½“æ€§: ã€Œã‚³ãƒ¼ãƒ’ãƒ¼ã€ãªã©å®Ÿç‰©ã‚¤ãƒ¡ãƒ¼ã‚¸ã§è¦ªã—ã¿ã‚„ã™ã„
* çµµæ–‡å­—: è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ãã€æ¥½ã—ã„

## 12.5 è¿”é‡‘ãƒ»ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯

* Stripe webhookã§æ¤œçŸ¥
* è³¼å…¥ãƒã‚¤ãƒ³ãƒˆã®ä»˜ä¸ã‚’å–æ¶ˆï¼ˆå°å¸³ã§ç›¸æ®ºï¼‰
* æ—¢ã«ãƒã‚¤ãƒ³ãƒˆãŒåˆ©ç”¨æ¸ˆã¿ã®å ´åˆã€æ®‹é«˜ãŒä¸è¶³ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚é‹ç”¨ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©

  * åŸå‰‡ï¼šæ®‹é«˜ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹ã“ã¨ã‚’è¨±å¯ã›ãšã€ç®¡ç†è€…èª¿æ•´ï¼ˆadmin_adjustï¼‰ã§å¸³å°»ã‚’åˆã‚ã›ã‚‹
  * ã™ã¹ã¦ç›£æŸ»ãƒ­ã‚°ã«æ®‹ã™

---

# 13. é…åˆ†ç‡ï¼ˆå£²ä¸Šèªè­˜ãƒ™ãƒ¼ã‚¹ãƒ»ç¨æŠœãƒ™ãƒ¼ã‚¹ï¼‰

## 13.1 å¯¾è±¡

* ã‚®ãƒ•ãƒˆå£²ä¸Šï¼ˆgift_redeemï¼‰ã®ç¨æŠœé‡‘é¡ãŒåˆ†æ¯
* æœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆã¯å¯¾è±¡å¤–
* ã‚µãƒ–ã‚¹ã‚¯å£²ä¸Šé…åˆ†ã¯å°†æ¥æ‹¡å¼µï¼ˆä»Šå›ã®å¿…é ˆè¦ä»¶ã¯ã‚®ãƒ•ãƒˆä¸­å¿ƒã ãŒã€è¨­è¨ˆä¸Šã¯ä¸¡å¯¾å¿œå¯èƒ½ï¼‰

## 13.2 é…åˆ†ãƒ«ãƒ¼ãƒ«

* ãƒ«ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—

  * `gift_share`ï¼ˆå¿…é ˆï¼‰
  * `subscription_share`ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
* ä¸€å¾‹ or ã‚­ãƒ£ã‚¹ãƒˆåˆ¥

  * MVPã¯ **global ã¨ cast** ã®2éšå±¤ã‚’å¿…é ˆå®Ÿè£…
  * å°†æ¥ï¼šcast_gift / cast_gift_category / cast_plan

## 13.3 ãƒ«ãƒ¼ãƒ«å„ªå…ˆé †ä½ï¼ˆå°†æ¥å«ã‚ãŸå®Œå…¨å½¢ï¼‰

1. cast Ã— giftï¼ˆå€‹åˆ¥ï¼‰
2. cast Ã— gift_category
3. cast Ã— all_gift
4. cast Ã— planï¼ˆã‚µãƒ–ã‚¹ã‚¯é…åˆ†ç”¨ï¼‰
5. cast Ã— all_subscription
6. global default

## 13.4 è¨ˆç®—ã¨ç¢ºå®š

* ã‚®ãƒ•ãƒˆé€ä¿¡æ™‚ã«å³æ™‚è¨ˆç®—ï¼ˆpayout_calculationsï¼‰
* ãƒ«ãƒ¼ãƒ«å¤‰æ›´å¾Œã®ã€Œå†è¨ˆç®—ã€ã¯Adminæ“ä½œï¼ˆå°†æ¥ã€‚MVPã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå›ºå®šã§é‹ç”¨å¯èƒ½ï¼‰
* æœˆæ¬¡ç²¾ç®—ã§ settlement_batches ã‚’ç¢ºå®šã—ã€æ”¯æ‰•é¡ã‚’å›ºå®šï¼ˆä»¥é™ã¯å¤‰æ›´ä¸å¯ï¼‰

---

# 14. éæ©Ÿèƒ½è¦ä»¶

## 14.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

* RLSå¿…é ˆï¼ˆDBã§ç‰©ç†é˜²æ­¢ï¼‰
* é‡è¦æ“ä½œã¯Server Actionsã¸é›†ç´„ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç›´DBç¦æ­¢ï¼‰
* LINE webhookï¼šç½²åæ¤œè¨¼ã€å†ªç­‰
* Stripe webhookï¼šç½²åæ¤œè¨¼ã€å†ªç­‰
* æ¨©é™æ˜‡æ ¼ã¯Adminã®ã¿
* envãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆt3-env or Zodï¼‰

## 14.2 ç›£æŸ»

* èª°ãŒ/ã„ã¤/ä½•ã‚’/æˆåŠŸå¤±æ•—/å·®åˆ† ã‚’ä¿å­˜
* ç›£æŸ»ãƒ­ã‚°ã¯æ”¹ã–ã‚“ä¸å¯ï¼ˆupdate/deleteç¦æ­¢ã€insertã®ã¿ï¼‰

## 14.3 å¯ç”¨æ€§ãƒ»é‹ç”¨

* webhookå†é€ãƒ»é‡è¤‡å—ä¿¡è€æ€§ï¼ˆå†ªç­‰ï¼‰
* é€ä¿¡å¤±æ•—æ™‚ã®å†é€æ‰‹æ®µï¼ˆç®¡ç†ç”»é¢ã§æ‰‹å‹•å†é€ï¼‰
* ãƒãƒƒãƒï¼ˆSLAé›†è¨ˆã€æœªè¿”ä¿¡æ¤œçŸ¥ï¼‰ã¯Route Handlersï¼‹cronå‰æ

## 14.4 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

* Inboxã¯é‡ããªã‚Šã‚„ã™ã„ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ã€Œé›†è¨ˆãƒ“ãƒ¥ãƒ¼ã€ã¾ãŸã¯ã€Œè¨ˆç®—æ¸ˆã¿ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚’æ¡ç”¨
* messagesã¯ (end_user_id, created_at desc) indexå¿…é ˆ

## 14.5 ãƒ­ã‚®ãƒ³ã‚°/ç›£è¦–

* Sentryï¼šserver/client
* é‡è¦ã‚¨ãƒ©ãƒ¼ï¼ˆwebhookå¤±æ•—ã€é€ä¿¡å¤±æ•—ã€ç²¾ç®—å¤±æ•—ï¼‰ã¯Sentryã§æ¤œçŸ¥

---

# 15. å—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆãƒ†ã‚¹ãƒˆè¦³ç‚¹ï¼‰

## 15.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/RLS

* CastãŒæ‹…å½“å¤–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® end_users/messages/memos ã‚’é–²è¦§ã§ããªã„
* Shadow castãŒé€ä¿¡æ“ä½œã‚’å®Ÿè¡Œã§ããªã„ï¼ˆUIãƒ»ã‚µãƒ¼ãƒãƒ»DBå…¨ã¦ã§æ‹’å¦ï¼‰
* Adminä»¥å¤–ãŒä¾¡æ ¼/é…åˆ†ç‡/ç²¾ç®—ã‚’å¤‰æ›´ã§ããªã„

## 15.2 LINEå†ªç­‰

* åŒä¸€LINEã‚¤ãƒ™ãƒ³ãƒˆãŒè¤‡æ•°å›å±Šã„ã¦ã‚‚ messages/checkins ãŒäºŒé‡ç™»éŒ²ã•ã‚Œãªã„

## 15.3 SLA/Inbox

* æœªè¿”ä¿¡æ™‚é–“ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
* pausedãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå„ªå…ˆåº¦ä½ä¸‹ã™ã‚‹
* å±é™ºãƒ•ãƒ©ã‚°ãŒInboxæœ€ä¸Šä½ã«å‡ºã‚‹ï¼ˆAdmin/Supervisorï¼‰

## 15.4 AIè¿”ä¿¡æ¡ˆ

* 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1æ—¥3å›åˆ¶é™ãŒåŠ¹ã
* 3æ¡ˆï¼ˆå…±æ„Ÿ/ç§°è³›/ææ¡ˆï¼‰ãŒä¿å­˜ãƒ»è¡¨ç¤ºã•ã‚Œã‚‹
* AIç”Ÿæˆã¯é€ä¿¡ã•ã‚Œãšã€äººé–“ã®é€ä¿¡ã®ã¿ã§LINEã¸å±Šã

## 15.5 Stripe

* webhookã§ status/current_period_end ãŒåŒæœŸã•ã‚Œã‚‹
* ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ãƒ—ãƒ©ãƒ³ä¾¡æ ¼ãŒã‚µãƒ–ã‚¹ã‚¯ä½œæˆã«åæ˜ ã•ã‚Œã‚‹
* ä¾¡æ ¼å¤‰æ›´ãŒç›£æŸ»ãƒ­ã‚°ã«æ®‹ã‚‹

## 15.6 ã‚®ãƒ•ãƒˆ/ãƒã‚¤ãƒ³ãƒˆ/é…åˆ†

* ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ãŒå°å¸³ã«åæ˜ ã•ã‚Œã‚‹
* æ®‹é«˜ä¸è¶³ã§ã‚®ãƒ•ãƒˆé€ä¿¡ã§ããªã„
* ã‚®ãƒ•ãƒˆé€ä¿¡ã§

  * user_point_ledger ãŒæ¸›ã‚‹
  * revenue_eventï¼ˆç¨æŠœï¼‰ãŒç«‹ã¤
  * payout_calculation ãŒä½œã‚‰ã‚Œã‚‹ï¼ˆç¨æŠœÃ—é…åˆ†ç‡ï¼‰
* æœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆã¯ payout ã«å½±éŸ¿ã—ãªã„
* æœˆæ¬¡ç²¾ç®—ã§åˆç®—ãŒä¸€è‡´ã™ã‚‹

---

# 16. å®Ÿè£…è¨­è¨ˆï¼ˆCursorç›´çµï¼‰

## 16.1 DBè¨­è¨ˆï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ï¼šå®Œå…¨ä¸€è¦§ï¼‰

> æ³¨ï¼šå‹ã¯Postgresæ¨™æº–ï¼ˆuuid/text/int/numeric/date/timestamptz/jsonb/boolï¼‰ã€‚
> ç›£æŸ»æ€§ã®ãŸã‚ã€é‡è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã¯åŸå‰‡ **è«–ç†å‰Šé™¤ï¼ˆactiveãƒ•ãƒ©ã‚°ï¼‰** ã‚’æ¡ç”¨ã—ã€ç‰©ç†deleteã¯ã—ãªã„ã€‚

### 16.1.1 Supabase Authï¼ˆæ—¢å­˜ï¼‰

* `auth.users`ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³ã«ä½¿ç”¨ï¼‰

### 16.1.2 ã‚¹ã‚¿ãƒƒãƒ•

#### `staff_profiles`

* `id uuid pk`ï¼ˆauth.users.idï¼‰
* `role text`ï¼ˆadmin/supervisor/castï¼‰
* `display_name text`
* `active bool default true`
* `capacity_limit int null`ï¼ˆé‹ç”¨ä¸Šé™ï¼‰
* `created_at timestamptz default now()`

indexï¼š

* `(role)`

---

### 16.1.3 ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼

#### `end_users`

* `id uuid pk`
* `line_user_id text unique not null`
* `nickname text not null`
* `birthday date null`
* `status text not null`ï¼ˆsubscription_statusï¼‰
* `plan_code text not null`
* `assigned_cast_id uuid null fk -> staff_profiles(id)`
* `paused_priority_penalty int not null default 0`
* `tags text[] not null default '{}'`
* `created_at timestamptz default now()`
* `updated_at timestamptz default now()`

indexï¼š

* `(assigned_cast_id)`
* `(status)`
* `(plan_code)`

#### `cast_assignments`ï¼ˆæ‹…å½“å±¥æ­´ï¼‰

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `from_cast_id uuid null fk -> staff_profiles(id)`
* `to_cast_id uuid fk -> staff_profiles(id)`
* `reason text null`
* `shadow_until timestamptz null`
* `created_by uuid fk -> staff_profiles(id)`
* `created_at timestamptz default now()`

indexï¼š

* `(end_user_id, created_at desc)`
* `(to_cast_id, created_at desc)`

---

### 16.1.4 ãƒ—ãƒ©ãƒ³ï¼ˆå†…å®¹ï¼‰

#### `plans`

* `plan_code text pk`
* `name text`
* `reply_sla_minutes int`
* `daily_checkin_enabled bool default true`
* `weekly_review_enabled bool`
* `priority_level int`
* `capacity_weight int`
* `active bool default true`

---

### 16.1.5 ã‚µãƒ–ã‚¹ã‚¯ä¾¡æ ¼ï¼ˆStripe Priceï¼‰

#### `plan_prices`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

* `id uuid pk`
* `plan_code text fk -> plans(plan_code)`
* `currency text default 'JPY'`
* `amount_monthly int not null`ï¼ˆè¡¨ç¤ºãƒ»å‚ç…§ç”¨ï¼‰
* `stripe_price_id text unique not null`
* `valid_from date not null`
* `active bool default true`
* `created_at timestamptz default now()`

indexï¼š

* `(plan_code, active, valid_from desc)`

#### `cast_plan_price_overrides`ï¼ˆã‚­ãƒ£ã‚¹ãƒˆåˆ¥ï¼‰

* `id uuid pk`
* `cast_id uuid fk -> staff_profiles(id)`
* `plan_code text fk -> plans(plan_code)`
* `currency text default 'JPY'`
* `amount_monthly int not null`
* `stripe_price_id text unique not null`
* `valid_from date not null`
* `active bool default true`
* `created_at timestamptz default now()`

uniqueï¼ˆæ¨å¥¨ï¼‰ï¼š

* `(cast_id, plan_code, valid_from)`

---

### 16.1.6 ã‚µãƒ–ã‚¹ã‚¯ï¼ˆStripeåŒæœŸï¼‰

#### `subscriptions`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `stripe_customer_id text`
* `stripe_subscription_id text unique`
* `status text not null`
* `plan_code text fk -> plans(plan_code)`
* `applied_stripe_price_id text not null`
* `current_period_end timestamptz null`
* `cancel_at_period_end bool default false`
* `created_at timestamptz default now()`
* `updated_at timestamptz default now()`

indexï¼š

* `(end_user_id)`
* `(status)`

---

### 16.1.7 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä¼šè©±ï¼‰

#### `messages`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `direction text not null`ï¼ˆin/outï¼‰
* `body text not null`
* `line_message_id text null unique`ï¼ˆinã§å¿…é ˆæ¨å¥¨ï¼‰
* `sent_by_staff_id uuid null fk -> staff_profiles(id)`ï¼ˆoutã®ã¿ï¼‰
* `sent_as_proxy bool default false`
* `proxy_for_cast_id uuid null fk -> staff_profiles(id)`
* `created_at timestamptz default now()`

indexï¼š

* `(end_user_id, created_at desc)`
* `(sent_by_staff_id, created_at desc)`

---

### 16.1.8 ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³

#### `checkins`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `date date not null`ï¼ˆJSTï¼‰
* `status text not null`ï¼ˆcircle/triangle/crossï¼‰
* `created_at timestamptz default now()`
* `updated_at timestamptz default now()`

uniqueï¼š

* `(end_user_id, date)`

indexï¼š

* `(end_user_id, date desc)`

---

### 16.1.9 ãƒ¡ãƒ¢ï¼ˆã‚«ãƒ†ã‚´ãƒª/ãƒ”ãƒ³/å±¥æ­´ï¼‰

#### `memos`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `category text not null`
* `pinned bool default false`
* `latest_body text not null`
* `updated_at timestamptz default now()`

indexï¼š

* `(end_user_id, pinned desc, updated_at desc)`

#### `memo_revisions`

* `id uuid pk`
* `memo_id uuid fk -> memos(id)`
* `body text not null`
* `edited_by uuid fk -> staff_profiles(id)`
* `created_at timestamptz default now()`

indexï¼š

* `(memo_id, created_at desc)`

---

### 16.1.10 èª•ç”Ÿæ—¥ãŠç¥ã„é€ä¿¡ãƒ•ãƒ©ã‚°

#### `birthday_congrats`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `year int not null`
* `sent_by uuid fk -> staff_profiles(id)`
* `sent_at timestamptz default now()`

uniqueï¼š

* `(end_user_id, year)`

---

### 16.1.11 AIè¿”ä¿¡æ¡ˆ

#### `ai_draft_requests`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `requested_by uuid fk -> staff_profiles(id)`
* `jst_date date not null`ï¼ˆåˆ¶é™åˆ¤å®šç”¨ï¼‰
* `context_snapshot jsonb not null`
* `success bool not null`
* `error_message text null`
* `created_at timestamptz default now()`

indexï¼š

* `(end_user_id, jst_date desc)`

#### `ai_drafts`

* `id uuid pk`
* `request_id uuid fk -> ai_draft_requests(id)`
* `type text not null`ï¼ˆempathy/praise/suggestï¼‰
* `body text not null`
* `created_at timestamptz default now()`

---

### 16.1.12 Shadowä¸‹æ›¸ã

#### `shadow_drafts`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `created_by uuid fk -> staff_profiles(id)`ï¼ˆShadow castï¼‰
* `body text not null`
* `created_at timestamptz default now()`

indexï¼š

* `(end_user_id, created_at desc)`

---

### 16.1.13 å±é™ºæ¤œçŸ¥

#### `risk_flags`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `detected_on_message_id uuid null fk -> messages(id)`
* `risk_level int not null`ï¼ˆ1-5ï¼‰
* `reasons text[] not null`
* `status text not null`ï¼ˆopen/ack/resolvedï¼‰
* `created_at timestamptz default now()`
* `resolved_by uuid null fk -> staff_profiles(id)`
* `resolved_at timestamptz null`

indexï¼š

* `(status, created_at desc)`
* `(end_user_id, created_at desc)`

---

### 16.1.14 ãƒã‚¤ãƒ³ãƒˆå•†å“ï¼ˆStripe one-timeï¼‰

#### `point_products`

* `id uuid pk`
* `name text not null`
* `points int not null`
* `price_excl_tax_jpy int not null`
* `tax_rate_id uuid fk -> tax_rates(id)`ï¼ˆæœ‰åŠ¹ç¨ç‡ï¼‰
* `price_incl_tax_jpy int not null`ï¼ˆè¡¨ç¤ºç”¨ï¼‰
* `stripe_price_id text unique not null`
* `active bool default true`
* `created_at timestamptz default now()`

> è¡¨ç¤ºã®éƒ½åˆä¸Šã€Œç¨è¾¼ä¾¡æ ¼ã€ã‚‚ä¿æŒã™ã‚‹ãŒã€ä¼šè¨ˆè¨ˆç®—ã¯ç¨ç‡ã¨ç¨æŠœã‚’åŸºæº–ã«ã™ã‚‹ã€‚

---

### 16.1.15 ç¨ç‡ï¼ˆå°†æ¥å¤‰æ›´ã«å‚™ãˆã‚‹ï¼‰

#### `tax_rates`

* `id uuid pk`
* `name text`ï¼ˆä¾‹ï¼šJP standardï¼‰
* `rate numeric(5,4) not null`ï¼ˆä¾‹ï¼š0.1000ï¼‰
* `effective_from date not null`
* `active bool default true`

---

### 16.1.16 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆå°å¸³ï¼ˆçœŸå®Ÿï¼‰

#### `user_point_ledger`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `delta_points int not null`ï¼ˆ+/-ï¼‰
* `reason text not null`ï¼ˆpurchase/gift_redeem/refund/chargeback/admin_adjustï¼‰
* `ref_type text not null`
* `ref_id text not null`
* `created_at timestamptz default now()`

indexï¼š

* `(end_user_id, created_at desc)`
  uniqueï¼ˆå†ªç­‰ï¼‰ï¼š
* `(reason, ref_type, ref_id)`

---

### 16.1.17 ã‚®ãƒ•ãƒˆã‚«ã‚¿ãƒ­ã‚°

#### `gift_catalog`

* `id uuid pk`
* `name text not null`
* `category text not null`
* `cost_points int not null`ï¼ˆ=ç¨æŠœå††ã®åŸºæº–ï¼‰
* `active bool default true`
* `sort_order int default 0`
* `icon text null`
* `created_at timestamptz default now()`

indexï¼š

* `(active, sort_order)`

---

### 16.1.18 ã‚®ãƒ•ãƒˆé€ä¿¡

#### `gift_sends`

* `id uuid pk`
* `end_user_id uuid fk -> end_users(id)`
* `cast_id uuid fk -> staff_profiles(id)`
* `gift_id uuid fk -> gift_catalog(id)`
* `cost_points int not null`
* `sent_at timestamptz default now()`
* `message_id uuid null fk -> messages(id)`ï¼ˆğŸã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºç”¨ï¼‰

indexï¼š

* `(cast_id, sent_at desc)`
* `(end_user_id, sent_at desc)`

---

### 16.1.19 å£²ä¸Šèªè­˜ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆåˆ†æ¯ï¼‰

#### `revenue_events`

* `id uuid pk`
* `event_type text not null`ï¼ˆgift_redeem / subscription_monthly / refund / chargeback / breakageï¼‰
* `end_user_id uuid fk -> end_users(id)`
* `cast_id uuid null fk -> staff_profiles(id)`ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆæ™‚ç‚¹ã®æ‹…å½“ï¼‰
* `occurred_on date not null`ï¼ˆJSTï¼‰
* `amount_excl_tax_jpy int not null`
* `tax_rate_id uuid fk -> tax_rates(id)`
* `tax_jpy int not null`
* `amount_incl_tax_jpy int not null`
* `source_ref_type text not null`ï¼ˆgift_send / stripe_invoice ç­‰ï¼‰
* `source_ref_id text not null`
* `metadata jsonb not null default '{}'`
* `created_at timestamptz default now()`

uniqueï¼ˆå†ªç­‰ï¼‰ï¼š

* `(event_type, source_ref_type, source_ref_id)`

indexï¼š

* `(cast_id, occurred_on desc)`
* `(end_user_id, occurred_on desc)`

> MVPã®å¿…é ˆï¼šgift_redeem
> breakageï¼ˆæœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆã®åç›ŠåŒ–ï¼‰ã¯å°†æ¥ã€‚å…¥ã‚Œã¦ã‚‚é…åˆ†è¨ˆç®—å¯¾è±¡å¤–ã«ã§ãã‚‹ã€‚

---

### 16.1.20 é…åˆ†ãƒ«ãƒ¼ãƒ«ï¼ˆæœ€ä½ï¼šglobal/castï¼‰

#### `payout_rules`

* `id uuid pk`
* `rule_type text not null`ï¼ˆgift_share / subscription_shareï¼‰
* `scope_type text not null`ï¼ˆglobal / cast / cast_gift / cast_gift_category / cast_planï¼‰
* `cast_id uuid null fk -> staff_profiles(id)`
* `gift_id uuid null fk -> gift_catalog(id)`
* `gift_category text null`
* `plan_code text null fk -> plans(plan_code)`
* `percent numeric(5,2) not null`ï¼ˆä¾‹ï¼š30.00ï¼‰
* `effective_from date not null`
* `effective_to date null`
* `active bool default true`
* `created_by uuid fk -> staff_profiles(id)`
* `created_at timestamptz default now()`

indexï¼š

* `(rule_type, scope_type, active, effective_from desc)`
* `(cast_id, rule_type, active, effective_from desc)`

---

### 16.1.21 é…åˆ†è¨ˆç®—çµæœï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰

#### `payout_calculations`

* `id uuid pk`
* `revenue_event_id uuid fk -> revenue_events(id)`
* `cast_id uuid fk -> staff_profiles(id)`
* `rule_id uuid fk -> payout_rules(id)`
* `percent_snapshot numeric(5,2) not null`
* `amount_jpy int not null`ï¼ˆç¨æŠœÃ—%ï¼‰
* `calculated_at timestamptz default now()`

uniqueï¼ˆåŒä¸€ã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾ã™ã‚‹äºŒé‡è¨ˆç®—é˜²æ­¢ï¼‰ï¼š

* `(revenue_event_id)`

indexï¼š

* `(cast_id, calculated_at desc)`

---

### 16.1.22 ç²¾ç®—ï¼ˆç¤¾å†…å ±é…¬ï¼‰

#### `settlement_batches`

* `id uuid pk`
* `period_from date not null`
* `period_to date not null`
* `status text not null`ï¼ˆdraft/approved/paidï¼‰
* `created_by uuid fk -> staff_profiles(id)`
* `created_at timestamptz default now()`
* `approved_by uuid null fk -> staff_profiles(id)`
* `approved_at timestamptz null`
* `paid_at timestamptz null`

uniqueï¼š

* `(period_from, period_to)`

#### `settlement_items`

* `id uuid pk`
* `batch_id uuid fk -> settlement_batches(id)`
* `cast_id uuid fk -> staff_profiles(id)`
* `amount_jpy int not null`
* `breakdown jsonb not null`ï¼ˆeventä¸€è¦§/é›†è¨ˆï¼‰
* `created_at timestamptz default now()`

uniqueï¼š

* `(batch_id, cast_id)`

---

### 16.1.23 Webhookå†ªç­‰ï¼ˆLINE/Stripeï¼‰

#### `webhook_events`

* `id uuid pk`
* `provider text not null`ï¼ˆline/stripeï¼‰
* `event_id text not null`
* `event_type text not null`
* `received_at timestamptz default now()`
* `processed_at timestamptz null`
* `success bool not null default false`
* `error_message text null`

uniqueï¼š

* `(provider, event_id)`

---

### 16.1.24 ç›£æŸ»ãƒ­ã‚°ï¼ˆæ”¹ã–ã‚“ä¸å¯ï¼‰

#### `audit_logs`

* `id uuid pk`
* `actor_staff_id uuid fk -> staff_profiles(id)`
* `action text not null`
* `target_type text not null`
* `target_id uuid not null`
* `success bool not null`
* `metadata jsonb not null default '{}'`
* `created_at timestamptz default now()`

indexï¼š

* `(created_at desc)`
* `(actor_staff_id, created_at desc)`
* `(target_type, target_id)`

---

## 16.2 RLSæ–¹é‡ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«åˆ¥ãƒ»å®Œå…¨ãƒ«ãƒ¼ãƒ«ï¼‰

### 16.2.1 å…±é€šå‰æ

* staffã¯Supabase Authã§ãƒ­ã‚°ã‚¤ãƒ³
* `staff_profiles.id = auth.uid()` ã§roleåˆ¤å®š
* Castã®æ‹…å½“åˆ¶å¾¡ã¯ `end_users.assigned_cast_id = auth.uid()`
* Shadowã¯ `cast_assignments.shadow_until` ã§æœŸé–“åˆ¤å®šï¼ˆå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é™ã‚Šé–²è¦§/ä¸‹æ›¸ãè¨±å¯ï¼‰

### 16.2.2 ãƒãƒªã‚·ãƒ¼ï¼ˆè¦ä»¶ã¨ã—ã¦ã®å®£è¨€ï¼‰

ä»¥ä¸‹ã¯ã€ŒDBãŒæ‹’å¦ã™ã‚‹ã€ã“ã¨ã‚’å¿…é ˆã¨ã™ã‚‹ï¼ˆUIã‚„ã‚µãƒ¼ãƒã ã‘ã§å®ˆã‚‰ãªã„ï¼‰ã€‚

#### staff_profiles

* selectï¼šæœ¬äººï¼‹Admin/Supervisor
* updateï¼šæœ¬äººï¼ˆè¡¨ç¤ºåç¨‹åº¦ï¼‰ï¼‹Admin
* insert/deleteï¼šAdminã®ã¿

#### end_users

* Admin/Supervisorï¼šå…¨select
* Castï¼š

  * selectï¼šæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
  * updateï¼šåŸå‰‡ä¸å¯ï¼ˆå¿…è¦ãªã‚‰ãƒ¡ãƒ¢ç­‰ã¯åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã§æ‰±ã†ï¼‰
* insertï¼šwebhook/é‹ç”¨ï¼ˆServer ActionçµŒç”±ã€Admin/Supervisorï¼‰

#### cast_assignments

* Admin/Supervisorï¼šselect/insert
* Castï¼šselectä¸å¯ï¼ˆé‹ç”¨ä¸Šä¸è¦ï¼‰
* update/deleteï¼šç¦æ­¢ï¼ˆå±¥æ­´æ”¹ã–ã‚“é˜²æ­¢ï¼‰

#### messages

* Admin/Supervisorï¼šå…¨select
* Castï¼šæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿select
* insertï¼ˆoutï¼‰ï¼š

  * Admin/Supervisorï¼šå¯
  * Castï¼šæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å¯
* update/deleteï¼šç¦æ­¢ï¼ˆæ”¹ã–ã‚“é˜²æ­¢ï¼‰
* Shadow castï¼šinsertä¸å¯ï¼ˆé€ä¿¡ç¦æ­¢ï¼‰ã€‚shadow_draftsã«é™å®šã€‚

#### checkins

* Admin/Supervisorï¼šå…¨select
* Castï¼šæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿select
* insert/updateï¼šwebhookï¼ˆServerå´ï¼‰ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰ã®ç›´æ¥å¤‰æ›´ã¯åŸå‰‡ä¸å¯ï¼ˆå¿…è¦ãªã‚‰Adminã®ã¿ï¼‰

#### memos / memo_revisions

* Admin/Supervisorï¼šå…¨select/insert/update
* Castï¼šæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿select/insert/update
* deleteï¼šç¦æ­¢ï¼ˆå±¥æ­´æ€§é‡è¦–ã€‚å¿…è¦ãªã‚‰active/archivedã§è«–ç†å‰Šé™¤ï¼‰

#### shadow_drafts

* Admin/Supervisorï¼šå…¨select
* Castï¼š

  * è‡ªåˆ†ãŒä½œæˆã—ãŸã‚‚ã®ã¯select
  * å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒShadowè¨±å¯ä¸­ã€ãªã‚‰insertå¯
* delete/updateï¼šç¦æ­¢ï¼ˆå±¥æ­´ï¼‰

#### ai_draft_requests / ai_drafts

* Admin/Supervisorï¼šå…¨select
* Castï¼šæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿selectã€ã‹ã¤requested_by=auth.uid() ã®insertå¯
* delete/updateï¼šç¦æ­¢

#### subscriptions

* Admin/Supervisorï¼šselectå¯
* Castï¼šæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿select
* å¤‰æ›´ç³»ï¼šAdminã®ã¿ï¼ˆãƒ—ãƒ©ãƒ³å¤‰æ›´ã€ä¾¡æ ¼å¤‰æ›´ï¼‰

#### plan_prices / cast_plan_price_overrides

* selectï¼šAdmin/Supervisorï¼ˆé‹ç”¨ã§Supervisorã¯é–²è¦§ã®ã¿ï¼‰
* insert/updateï¼šAdminã®ã¿
* deleteï¼šç¦æ­¢ï¼ˆactive=falseã§ç„¡åŠ¹åŒ–ï¼‰

#### point_products / gift_catalog / payout_rules

* selectï¼šAdmin/Supervisorï¼ˆCastã¯é–²è¦§ä¸è¦ï¼‰
* insert/updateï¼šAdminã®ã¿
* deleteï¼šç¦æ­¢ï¼ˆactive=falseï¼‰

#### user_point_ledger / gift_sends / revenue_events / payout_calculations / settlements

* Admin/Supervisorï¼šé–²è¦§å¯ï¼ˆç²¾ç®—ã¯Adminã®ã¿ï¼‰
* Castï¼š

  * gift_sendsï¼šè‡ªåˆ†å®›ã®ã‚‚ã®ã®ã¿é–²è¦§å¯
  * payout_calculationsï¼šè‡ªåˆ†cast_idã®ã‚‚ã®ã®ã¿é–²è¦§å¯ï¼ˆè¦‹è¾¼ã¿å ±é…¬ã¨ã—ã¦ï¼‰
  * revenue_eventsï¼šè‡ªåˆ†cast_idã®ã‚‚ã®ã®ã¿é–²è¦§å¯ï¼ˆå¿…è¦ãªã‚‰ï¼‰
* å¤‰æ›´ç³»ï¼šAdminã®ã¿ã€ã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ ï¼ˆwebhook/Server Actionsï¼‰é™å®š

#### audit_logs / webhook_events

* audit_logs selectï¼šAdmin/Supervisor
* webhook_events selectï¼šAdmin/Supervisor
* insertï¼šã‚·ã‚¹ãƒ†ãƒ ã®ã¿
* update/deleteï¼šç¦æ­¢ï¼ˆprocessed_atæ›´æ–°ãŒå¿…è¦ãªã‚‰webhook_eventsã®ã¿ã‚·ã‚¹ãƒ†ãƒ ã§updateå¯ï¼‰

---

## 16.3 èªè¨¼ãƒ»èªå¯è¨­è¨ˆï¼ˆSupabase Authï¼‰

* ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿ãƒ­ã‚°ã‚¤ãƒ³
* åˆæœŸç®¡ç†è€…ï¼ˆAdminï¼‰ã¯æ‰‹å‹•ã§ä½œæˆ
* ä»¥é™ã¯AdminãŒæ‹›å¾…ãƒ»ä½œæˆï¼ˆroleã‚’ä»˜ä¸ï¼‰
* èªå¯ã¯ä¸‰é‡ã§è¡Œã†

  1. UIè¡¨ç¤ºåˆ¶å¾¡ï¼ˆUXï¼‰
  2. Server Actionså†…ã®role/æ‹…å½“ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰
  3. RLSã§DBãŒæ‹’å¦ï¼ˆæœ€é‡è¦ï¼‰

---

## 16.4 Server Actionsä¸€è¦§ï¼ˆè²¬å‹™ãƒ»æ¨©é™ãƒ»ç›£æŸ»ï¼‰

> é‡è¦å‡¦ç†ï¼ˆä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãƒ»å…¬é–‹ãƒ»æ¨©é™å¤‰æ›´ãƒ»ç›£æŸ»è¨˜éŒ²ï¼‰ã¯å¿…ãšã‚µãƒ¼ãƒå´ã€‚

### 16.4.1 ãƒãƒ£ãƒƒãƒˆ

* `sendMessage(endUserId, body)`

  * æ¨©é™ï¼šæ‹…å½“Cast / Supervisor / Admin
  * å‡¦ç†ï¼š

    * messages(out) insert
    * LINE pushé€ä¿¡ï¼ˆå¤±æ•—æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã¨å†é€å°ç·šï¼‰
    * auditï¼šSEND_MESSAGEï¼ˆsuccess/failureï¼‰
* `sendProxyMessage(endUserId, body, reason?)`

  * æ¨©é™ï¼šSupervisor / Admin
  * å‡¦ç†ï¼š

    * messages(out) insertï¼ˆsent_as_proxy=true, proxy_for_cast_id=æ‹…å½“ï¼‰
    * LINEé€ä¿¡
    * auditï¼šPROXY_SEND
    * æ‹…å½“ã‚­ãƒ£ã‚¹ãƒˆã¸ç®¡ç†ç”»é¢é€šçŸ¥ï¼ˆå†…éƒ¨ã®ã¿ï¼‰

### 16.4.2 æ‹…å½“ãƒ»Shadow

* `assignCast(endUserId, toCastId, reason, shadowUntil?)`

  * æ¨©é™ï¼šAdminï¼ˆã¾ãŸã¯Supervisorï¼‰
  * å‡¦ç†ï¼š

    * cast_assignments insert
    * end_users.assigned_cast_idæ›´æ–°
    * auditï¼šASSIGN_CAST
* `createShadowDraft(endUserId, body)`

  * æ¨©é™ï¼šShadowå¯¾è±¡Castã®ã¿
  * å‡¦ç†ï¼š

    * shadow_drafts insert
    * auditï¼šCREATE_SHADOW_DRAFT
  * **é€ä¿¡ä¸å¯**ï¼ˆsendMessageã‚’ä½¿ãˆãªã„/æ‹’å¦ï¼‰

### 16.4.3 ãƒ¡ãƒ¢

* `upsertMemo(endUserId, category, pinned, body)`

  * æ¨©é™ï¼šæ‹…å½“Cast / Supervisor / Admin
  * å‡¦ç†ï¼š

    * memos upsert
    * memo_revisions insert
    * auditï¼šUPSERT_MEMO / PIN_MEMO

### 16.4.4 èª•ç”Ÿæ—¥

* `markBirthdayCongratulated(endUserId)`

  * æ¨©é™ï¼šæ‹…å½“Cast / Supervisor / Admin
  * å‡¦ç†ï¼š

    * birthday_congrats upsertï¼ˆyearå˜ä½ï¼‰
    * auditï¼šBIRTHDAY_SENT

### 16.4.5 AIè¿”ä¿¡æ¡ˆ

* `generateAiDrafts(endUserId)`

  * æ¨©é™ï¼šæ‹…å½“Cast / Supervisor / Admin
  * åˆ¶é™ï¼š1ãƒ¦ãƒ¼ã‚¶ãƒ¼1æ—¥3å›ï¼ˆJSTï¼‰
  * å‡¦ç†ï¼š

    * contextåé›†ï¼ˆç›´è¿‘messages, pinned memos, 7æ—¥checkins, style summaryï¼‰
    * ai_draft_requests insertï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
    * ai_drafts 3ä»¶ insert
    * auditï¼šAI_DRAFT_REQUESTï¼ˆsuccess/failureï¼‰

### 16.4.6 ä¾¡æ ¼ï¼ˆã‚­ãƒ£ã‚¹ãƒˆåˆ¥ãƒ—ãƒ©ãƒ³é‡‘é¡ï¼‰

* `upsertCastPlanPriceOverride(castId, planCode, stripePriceId, amountMonthly, validFrom, active)`

  * æ¨©é™ï¼šAdmin
  * auditï¼šUPSERT_CAST_PLAN_PRICE

* `changeUserSubscriptionPrice(endUserId, mode: next_cycle|immediate)`

  * æ¨©é™ï¼šAdmin
  * å‡¦ç†ï¼š

    * overrideâ†’defaultã§æ–°priceè§£æ±º
    * Stripe subscription updateï¼ˆmodeã«ã‚ˆã‚Šprorationï¼‰
    * subscriptions.applied_stripe_price_idæ›´æ–°ï¼ˆæœ€çµ‚ã¯webhookã§æ•´åˆï¼‰
    * auditï¼šCHANGE_SUBSCRIPTION_PRICEï¼ˆbefore/afterï¼‰

### 16.4.7 ãƒã‚¤ãƒ³ãƒˆè³¼å…¥/ã‚®ãƒ•ãƒˆé€ä¿¡/é…åˆ†

* `createPointCheckoutSession(endUserId, pointProductId)`

  * æ¨©é™ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ä»£æ›¿ï¼ˆWebãƒšãƒ¼ã‚¸çµŒç”±ï¼‰ã€‚èªè¨¼ã¯line_user_idãƒˆãƒ¼ã‚¯ãƒ³ç­‰ã§è¡Œã†ï¼ˆè©³ç´°å¾Œè¿°ï¼‰
  * auditï¼šPOINT_CHECKOUT_CREATE

* `sendGift(endUserId, giftId)`

  * æ¨©é™ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼ˆåŒä¸Šï¼‰
  * **DBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¿…é ˆ**
  * å‡¦ç†ï¼ˆåŸå­ï¼‰ï¼š

    1. æ®‹é«˜ç¢ºèªï¼ˆledger sum / cacheï¼‰
    2. gift_sends insertï¼ˆcast_idã¯ãã®æ™‚ç‚¹ã®æ‹…å½“ï¼‰
    3. user_point_ledger insertï¼ˆdelta=-cost_points, reason=gift_redeem, ref=gift_sendï¼‰
    4. revenue_events insertï¼ˆgift_redeem, amount_excl_tax=cost_points, ç¨ç‡ã«åŸºã¥ã tax/ç¨è¾¼è¨ˆç®—, ref=gift_sendï¼‰
    5. payout_ruleè§£æ±ºï¼ˆglobalâ†’castï¼‰â†’ payout_calculations insertï¼ˆç¨æŠœÃ—%ï¼‰
    6. messages insertï¼ˆğŸã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºç”¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸è‡ªå‹•é€ä¿¡ã¯ã—ãªã„ï¼‰
    7. auditï¼šGIFT_SENDï¼ˆè¨ˆç®—å†…è¨³å«ã‚€ï¼‰

* `upsertPayoutRule(...)`

  * æ¨©é™ï¼šAdmin
  * auditï¼šUPSERT_PAYOUT_RULEï¼ˆbefore/afterï¼‰

* `createSettlementBatch(period_from, period_to)`

  * æ¨©é™ï¼šAdmin
  * å‡¦ç†ï¼š

    * payout_calculations ã‚’é›†è¨ˆã—ã¦ settlement_items ä½œæˆ
    * settlement_batches draft ä½œæˆ
    * auditï¼šSETTLEMENT_BATCH_CREATE

* `approveSettlementBatch(batchId)`

  * æ¨©é™ï¼šAdmin
  * auditï¼šSETTLEMENT_BATCH_APPROVE

* `markSettlementBatchPaid(batchId)`

  * æ¨©é™ï¼šAdmin
  * auditï¼šSETTLEMENT_BATCH_PAID

---

## 16.5 Route Handlersï¼ˆwebhook/cron/ç®¡ç†å‡¦ç†ï¼‰

### 16.5.1 LINE webhook

* `POST /api/webhooks/line`

  * ç½²åæ¤œè¨¼
  * eventå†ªç­‰ï¼ˆwebhook_eventsï¼‰
  * å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆ

    * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆtextï¼‰

      * end_userä½œæˆ/æ›´æ–°ï¼ˆline_user_idï¼‰
      * messages(in) insertï¼ˆline_message_id uniqueï¼‰
      * å±é™ºæ¤œçŸ¥ï¼ˆMVPã§ã¯æœªå®Ÿè£…ã€å°†æ¥æ‹¡å¼µï¼‰
    * postbackï¼ˆcheckinï¼‰

      * checkins upsertï¼ˆJSTæ—¥ä»˜ï¼‰
      * Inboxã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°ç”¨ã«è¨˜éŒ²ï¼ˆmessagesã«ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦æ®‹ã—ã¦ã‚‚è‰¯ã„ï¼‰
    * followï¼ˆå‹é”è¿½åŠ ï¼‰

      * end_userä½œæˆï¼ˆstatus='incomplete'ï¼‰
      * æ­“è¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆä¾‹å¤–çš„ã«è‡ªå‹•é€ä¿¡OKï¼‰
      * æœªå¥‘ç´„è€…ç”¨ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®š
  * auditï¼šLINE_WEBHOOK_RECEIVED / LINE_MESSAGE_SAVED / CHECKIN_RECORDED / LINE_FOLLOW

### 16.5.2 Stripe webhook

* `POST /api/webhooks/stripe`

  * ç½²åæ¤œè¨¼
  * eventå†ªç­‰ï¼ˆwebhook_eventsï¼‰
  * å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆï¼ˆMVPå¿…é ˆï¼‰

    * checkout.session.completedï¼ˆãƒã‚¤ãƒ³ãƒˆè³¼å…¥ç¢ºå®šï¼‰

      * user_point_ledger insertï¼ˆ+points, reason=purchaseï¼‰
      * auditï¼šPOINT_PURCHASE_CONFIRMED
    * customer.subscription.updated / created / deleted

      * subscriptions/end_users.status ã‚’åŒæœŸ
      * auditï¼šSUBSCRIPTION_SYNC
    * invoice.payment_failedï¼ˆpast_dueï¼‰

      * statusæ›´æ–°
  * è¿”é‡‘/ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ç³»ï¼ˆMVPå¯¾å¿œæ¨å¥¨ï¼‰

    * charge.refunded / charge.dispute.* ç­‰ã‚’æ¤œçŸ¥ã—ã€user_point_ledgerã«ç›¸æ®ºã‚’å…¥ã‚Œã‚‹ï¼ˆé‹ç”¨ãƒ«ãƒ¼ãƒ«ã«å¾“ã†ï¼‰
    * auditï¼šREFUND_OR_CHARGEBACK_HANDLED

### 16.5.3 cron/ãƒãƒƒãƒ

* `GET /api/jobs/inbox-metrics`

  * æœªè¿”ä¿¡æ™‚é–“ã€SLAæ®‹ã€æœªå ±å‘Šã€pausedãƒšãƒŠãƒ«ãƒ†ã‚£ãªã©ã‚’ç®—å‡ºï¼ˆãƒ“ãƒ¥ãƒ¼ or ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
* `GET /api/jobs/risk-scan`ï¼ˆå°†æ¥ï¼‰

  * å±é™ºæ¤œçŸ¥ã®é«˜åº¦åŒ–ï¼ˆNLP/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰

---

# 17. UIè¨­è¨ˆï¼ˆãƒšãƒ¼ã‚¸æ§‹æˆãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè²¬å‹™ï¼‰

## 17.1 Next.js App Router ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆMVPï¼‰

* `/login`
* `/inbox`
* `/users`
* `/users/[id]`
* `/chat/[id]`
* `/admin/staff`
* `/admin/pricing`ï¼ˆã‚­ãƒ£ã‚¹ãƒˆåˆ¥ãƒ—ãƒ©ãƒ³ä¾¡æ ¼ï¼‰
* `/admin/gifts`ï¼ˆgift_catalog / point_productsï¼‰
* `/admin/payout-rules`
* `/admin/settlements`
* `/admin/audit`
* `/help`ï¼ˆä½¿ã„æ–¹ãƒšãƒ¼ã‚¸ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘Webå°ç·šï¼‰
* `/gift`ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚®ãƒ•ãƒˆé€ä¿¡ãƒšãƒ¼ã‚¸ï¼‰
* `/points`ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ãƒšãƒ¼ã‚¸ï¼‰

> ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒšãƒ¼ã‚¸ã¯ã€ŒLINEã‹ã‚‰é–‹ãã€å‰æã€‚ãƒ­ã‚°ã‚¤ãƒ³ã¯ã—ãªã„ï¼ˆline_user_idã‚’è­˜åˆ¥ã™ã‚‹ç°¡æ˜“ãƒˆãƒ¼ã‚¯ãƒ³æ–¹å¼ï¼‰ã€‚
> â€»Botæ„Ÿã‚¼ãƒ­ã®ãŸã‚ã€ãƒˆãƒ¼ã‚¯ã«è‡ªå‹•é€ä¿¡ã—ãªã„ã€‚ãƒªãƒ³ã‚¯ã¯ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œä½¿ã„æ–¹ã€ã‹ã‚‰è¾¿ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## 17.2 UIã®è²¬å‹™

* Data fetchï¼šServer Actionsï¼ˆåŸå‰‡ï¼‰
* Mutationï¼šServer Actionsï¼ˆå¿…é ˆï¼‰
* ç®¡ç†ç³»ãƒãƒƒãƒ/webhookï¼šRoute Handlers
* ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šTanStack Tableï¼ˆInboxã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã€ç›£æŸ»ãƒ­ã‚°ãªã©ï¼‰

---

# 18. å…¥åŠ›é …ç›®ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆZodï¼‰

## 18.1 è¿”ä¿¡

* `body`ï¼šå¿…é ˆã€æœ€å¤§æ–‡å­—æ•°ï¼ˆä¾‹ï¼š2000ï¼‰
* ç¦æ­¢ï¼šç©ºç™½ã®ã¿
* é€ä¿¡å‰ç¢ºèªï¼ˆä»£ç†è¿”ä¿¡ã¯è­¦å‘Šè¡¨ç¤ºï¼‰

## 18.2 ãƒ¡ãƒ¢

* categoryï¼šå¿…é ˆï¼ˆå›ºå®šå€™è£œï¼‹è‡ªç”±å…¥åŠ›ã®ã©ã¡ã‚‰ã‹ã€MVPã¯å›ºå®šå€™è£œæ¨å¥¨ï¼‰
* bodyï¼šå¿…é ˆã€æœ€å¤§æ–‡å­—æ•°ï¼ˆä¾‹ï¼š5000ï¼‰
* pinnedï¼šbool

## 18.3 ä¾¡æ ¼/é…åˆ†

* percentï¼š0ã€œ100ã€å°‘æ•°2æ¡
* valid_fromï¼šæ—¥ä»˜å¿…é ˆ
* stripe_price_idï¼šå¿…é ˆï¼ˆStripeå´ã¨ä¸€è‡´ï¼‰

## 18.4 ã‚®ãƒ•ãƒˆ

* cost_pointsï¼šæ­£ã®æ•´æ•°
* é€ä¿¡æ™‚ï¼šæ®‹é«˜ãƒã‚§ãƒƒã‚¯å¿…é ˆï¼ˆä¸è¶³ãªã‚‰ã‚¨ãƒ©ãƒ¼ï¼‰

---

# 19. ã‚¨ãƒ©ãƒ¼æ™‚ã®æŒ™å‹•ï¼ˆä¾‹å¤–è¨­è¨ˆï¼‰

## 19.1 LINEé€ä¿¡å¤±æ•—

* sendMessageå¤±æ•—æ™‚ï¼š

  * messages(out)ã¯ã€Œé€ä¿¡å¤±æ•—ã€çŠ¶æ…‹ã‚’ä¿æŒã—ãŸã„å ´åˆã€message_statusåˆ—ã‚’è¿½åŠ ï¼ˆå°†æ¥ï¼‰
  * MVPã§ã¯ auditã«failureè¨˜éŒ²ï¼‹UIã§å†é€ãƒœã‚¿ãƒ³ï¼ˆå†é€ã¯Server Actionï¼‰

## 19.2 webhookå¤±æ•—

* webhook_eventsã«error_messageã‚’ä¿å­˜
* ç®¡ç†ç”»é¢ã§Webhookå¤±æ•—ä¸€è¦§ï¼ˆå°†æ¥ï¼‰ã¾ãŸã¯Sentryã§ã‚¢ãƒ©ãƒ¼ãƒˆ

## 19.3 ã‚®ãƒ•ãƒˆé€ä¿¡ç«¶åˆ

* äºŒé‡é€ä¿¡/é€£æ‰“ã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§é˜²ã
* user_point_ledgerã®æ®‹é«˜ãŒè² ã«ãªã‚‰ãªã„ã‚ˆã†ã«ãƒ­ãƒƒã‚¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦FOR UPDATEç›¸å½“ï¼‰

## 19.4 Stripeã¨DBçŠ¶æ…‹ä¸æ•´åˆ

* çœŸå®Ÿã¯Stripe webhook
* ç®¡ç†ç”»é¢ã«ã¯ã€Œæœ€çµ‚åŒæœŸæ™‚åˆ»ã€ã‚’è¡¨ç¤º
* æ‰‹å‹•å†åŒæœŸï¼ˆAdminç”¨ï¼‰ã‚’å°†æ¥è¿½åŠ å¯èƒ½

---

# 20. ãƒã‚±ãƒƒãƒˆåˆ†å‰²ï¼ˆGitHub Issueå½¢å¼ï¼šå®Œå…¨ä¸€è¦§ï¼‰

## Epic 1ï¼šåŸºç›¤ï¼ˆDB/RLS/Authï¼‰

1. DB migrationsï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»åˆ¶ç´„ãƒ»indexï¼‰
2. RLSãƒãƒªã‚·ãƒ¼å®Ÿè£…ï¼ˆCastæ‹…å½“/Shadow/ç®¡ç†è€…ï¼‰
3. staff_profilesé‹ç”¨ï¼ˆæ‹›å¾…/roleä»˜ä¸ï¼‰
4. Sentryå°å…¥ï¼ˆserver/clientï¼‰
5. env validationï¼ˆt3-env or zodï¼‰

## Epic 2ï¼šLINEé€£æº

6. LINE webhookï¼ˆç½²åæ¤œè¨¼ï¼‹å†ªç­‰ï¼‰
7. messages(in)ä¿å­˜ã€end_userä½œæˆ/æ›´æ–°
8. postback checkin upsertï¼ˆFlex Messageå®Ÿè£…ï¼‰
9. follow eventå‡¦ç†ï¼ˆæ­“è¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡æ›¿ï¼‰
10. ~~å±é™ºæ¤œçŸ¥ï¼ˆæœ€ä½é™ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰â†’risk_flagsï¼‰~~ â†’ å°†æ¥æ‹¡å¼µã¸ç§»å‹•

## Epic 3ï¼šç®¡ç†ç”»é¢ï¼ˆé‹ç”¨ã®ä¸­å¿ƒï¼‰

11. Inboxï¼ˆãƒ•ã‚£ãƒ«ã‚¿/ã‚½ãƒ¼ãƒˆ/æœªè¿”ä¿¡æ™‚é–“/SLAæ®‹/è­¦å‘Šè¡¨ç¤ºï¼‰
12. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆæ¤œç´¢/ã‚¿ã‚°ï¼‰
13. ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ï¼ˆå¥‘ç´„/å±¥æ­´/ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³/èª•ç”Ÿæ—¥/ãƒ¡ãƒ¢ï¼‰
14. ãƒãƒ£ãƒƒãƒˆç”»é¢ï¼ˆè¿”ä¿¡/ä»£ç†è¿”ä¿¡/ãƒ¡ãƒ¢/èª•ç”Ÿæ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰
15. ç›£æŸ»ãƒ­ã‚°é–²è¦§ï¼ˆAdmin/Supervisorï¼‰

## Epic 4ï¼šAIè¿”ä¿¡æ¡ˆ

16. AI draft requestï¼ˆåˆ¶é™ãƒ»contextä½œæˆãƒ»ã‚­ãƒ£ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è¦ç´„åˆ©ç”¨ï¼‰
17. 3æ¡ˆç”Ÿæˆãƒ»ä¿å­˜ãƒ»UIè¡¨ç¤º

## Epic 5ï¼šStripeï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‹ä¾¡æ ¼ï¼‰

17. Stripe webhookï¼ˆsubscriptionåŒæœŸã€ãƒˆãƒ©ã‚¤ã‚¢ãƒ«â†’activeç§»è¡Œï¼‰
18. ãƒ—ãƒ©ãƒ³/ä¾¡æ ¼è¡¨ç¤ºã€å¥‘ç´„ã‚«ãƒ¼ãƒ‰
19. cast_plan_price_overrides CRUDï¼ˆAdminï¼‰
20. priceå¤‰æ›´ï¼ˆæ¬¡å›/å³æ™‚é¸æŠUIï¼‰ï¼‹ç›£æŸ»

## Epic 6ï¼šãƒã‚¤ãƒ³ãƒˆ/ã‚®ãƒ•ãƒˆï¼ˆAâ€™ï¼‰

21. point_products/gift_catalog CRUDï¼ˆAdminï¼‰ï¼‹åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
22. ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ Checkout sessionä½œæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒšãƒ¼ã‚¸ã€JWTèªè¨¼ï¼‰
23. Stripe webhookã§ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ï¼ˆledgerï¼‰
24. ã‚®ãƒ•ãƒˆé€ä¿¡ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆledger/revenue/payout/messagesï¼‰
25. Castå‘ã‘ã€Œã‚®ãƒ•ãƒˆå—é ˜ãƒ»è¦‹è¾¼ã¿é…åˆ†ã€è¡¨ç¤º

## Epic 7ï¼šé…åˆ†/ç²¾ç®—ï¼ˆçµŒç†ï¼‰

26. payout_rules CRUDï¼ˆglobal/castï¼‰
27. payout_calculationsç”Ÿæˆï¼ˆã‚®ãƒ•ãƒˆé€ä¿¡æ™‚ï¼‰
28. settlement_batches ä½œæˆâ†’approveâ†’paid
29. ç²¾ç®—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæœŸé–“é›†è¨ˆï¼‰

## Epic 8ï¼šãƒ—ãƒ©ãƒ³è³¼å…¥ãƒ•ãƒ­ãƒ¼ï¼ˆãƒˆãƒ©ã‚¤ã‚¢ãƒ«ï¼‰

30. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼JWTå®Ÿè£…
31. ã‚­ãƒ£ã‚¹ãƒˆé¸æŠç”»é¢ï¼ˆ/subscribe/castã€ä¾¡æ ¼è¡¨ç¤ºï¼‰
32. ãƒ—ãƒ©ãƒ³é¸æŠç”»é¢ï¼ˆ/subscribe/planã€ãƒˆãƒ©ã‚¤ã‚¢ãƒ«èª¬æ˜ï¼‰
33. Stripe Checkout Sessionä½œæˆï¼ˆtrial_period_days=7ï¼‰
34. ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡æ›¿ï¼ˆæœªå¥‘ç´„è€…ç”¨/å¥‘ç´„è€…ç”¨ï¼‰

## Epic 9ï¼šãƒ†ã‚¹ãƒˆ

35. Vitestï¼šé…åˆ†è¨ˆç®—ãƒ»ç¨è¨ˆç®—ãƒ»ãƒ«ãƒ¼ãƒ«è§£æ±ºãƒ»SLAè¨ˆç®—ãƒ»JWTæ¤œè¨¼
36. Playwrightï¼šãƒ­ã‚°ã‚¤ãƒ³â†’Inboxâ†’è¿”ä¿¡â†’ä»£ç†è¿”ä¿¡â†’ã‚®ãƒ•ãƒˆè¨ˆç®—åæ˜ â†’ãƒ—ãƒ©ãƒ³è³¼å…¥ãƒ•ãƒ­ãƒ¼

---

# 21. è¿½åŠ ã®é‡è¦é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆå¿…ãšå®ˆã‚‹ï¼‰

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è‡ªå‹•é€ä¿¡ã¯ç¦æ­¢ï¼ˆä¾‹å¤–ãªã—ï¼‰
* AIã¯ä¸‹æ›¸ãã®ã¿ã€‚é€ä¿¡ã¯äººé–“ã®ã¿
* Shadowã¯é€ä¿¡ä¸å¯ï¼ˆä»•çµ„ã¿ã§é˜²ãï¼‰
* ç›£æŸ»ãƒ­ã‚°ã¯æ”¹ã–ã‚“ä¸å¯ï¼ˆupdate/deleteç¦æ­¢ï¼‰
* ãƒã‚¤ãƒ³ãƒˆæœªä½¿ç”¨ã¯é…åˆ†å¯¾è±¡å¤–ï¼ˆé‹å–¶100%ï¼‰
* é…åˆ†ã¯ç¨æŠœãƒ™ãƒ¼ã‚¹ï¼ˆä¼šè¨ˆå„ªå…ˆï¼‰
* webhookå†ªç­‰ã¯å¿…é ˆï¼ˆLINE/Stripeï¼‰

---

# 22. å®Ÿè£…ä¸Šã®å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆç’°å¢ƒå¤‰æ•°ï¼‰

## åŸºæœ¬è¨­å®š

* `NEXT_PUBLIC_SUPABASE_URL`
* `NEXT_PUBLIC_SUPABASE_ANON_KEY`
* `SUPABASE_SERVICE_ROLE_KEY`ï¼ˆã‚µãƒ¼ãƒå°‚ç”¨ï¼‰
* `APP_BASE_URL`

## LINEé€£æº

* `LINE_CHANNEL_SECRET`
* `LINE_CHANNEL_ACCESS_TOKEN`
* `RICH_MENU_ID_UNCONTRACTED`ï¼ˆæœªå¥‘ç´„è€…ç”¨ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
* `RICH_MENU_ID_CONTRACTED`ï¼ˆå¥‘ç´„è€…ç”¨ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰

## ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼

* `LINE_USER_TOKEN_SECRET`ï¼ˆJWTç½²åç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰

## Stripeé€£æº

* `STRIPE_SECRET_KEY`
* `STRIPE_WEBHOOK_SECRET`

## AIè¨­å®š

* `AI_PROVIDER_KEY`ï¼ˆClaudeï¼‰
* `AI_DRAFT_DAILY_LIMIT=3`
* `AI_TOKEN_LIMIT`ï¼ˆä¸Šé™ï¼‰

## SLAãƒ»é‹ç”¨è¨­å®š

* `SLA_WARNING_LIGHT_MINUTES=240`ï¼ˆLightè­¦å‘Šé–¾å€¤: æ®‹ã‚Š4æ™‚é–“ï¼‰
* `SLA_WARNING_STANDARD_MINUTES=120`ï¼ˆStandardè­¦å‘Šé–¾å€¤: æ®‹ã‚Š2æ™‚é–“ï¼‰
* `SLA_WARNING_PREMIUM_MINUTES=30`ï¼ˆPremiumè­¦å‘Šé–¾å€¤: æ®‹ã‚Š30åˆ†ï¼‰
* `UNREPORTED_DAYS_THRESHOLD=2`ï¼ˆæœªå ±å‘Šåˆ¤å®š: 2æ—¥ï¼‰

## ãƒˆãƒ©ã‚¤ã‚¢ãƒ«è¨­å®š

* `TRIAL_PERIOD_DAYS=7`
* `TRIAL_PLAN_CODE=standard`

## ãã®ä»–

* `DEFAULT_TAX_RATE_ID`ï¼ˆç¨ç‡ã®æœ‰åŠ¹IDï¼‰

---

## ä»˜éŒ²Aï¼šä¸»è¦ãªç›£æŸ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ï¼ˆaudit_logs.actionï¼‰

* LINE_WEBHOOK_RECEIVED
* LINE_MESSAGE_SAVED
* CHECKIN_RECORDED
* SEND_MESSAGE
* PROXY_SEND
* ASSIGN_CAST
* CREATE_SHADOW_DRAFT
* UPSERT_MEMO
* PIN_MEMO
* BIRTHDAY_SENT
* AI_DRAFT_REQUEST
* SUBSCRIPTION_SYNC
* UPSERT_CAST_PLAN_PRICE
* CHANGE_SUBSCRIPTION_PRICE
* POINT_CHECKOUT_CREATE
* POINT_PURCHASE_CONFIRMED
* GIFT_SEND
* UPSERT_PAYOUT_RULE
* SETTLEMENT_BATCH_CREATE
* SETTLEMENT_BATCH_APPROVE
* SETTLEMENT_BATCH_PAID
* REFUND_OR_CHARGEBACK_HANDLED

---

## ä»˜éŒ²Bï¼šMVPã®æœ€çµ‚ç¢ºå®šäº‹é …ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰

* [x] æ‹…å½“ã¯åŸå‰‡1äººå›ºå®šã€å¼•ãç¶™ãã¯å±¥æ­´
* [x] Shadowã¯ä¸‹æ›¸ãã®ã¿ã€é€ä¿¡ä¸å¯
* [x] ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã¯ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼postback
* [x] pausedã¯å—ä¿¡ç¶™ç¶šã€Inboxå„ªå…ˆåº¦ä½ä¸‹
* [x] å±é™ºæ¤œçŸ¥ã¯Admin+Supervisorã¸
* [x] AIè¿”ä¿¡æ¡ˆã¯ä¸‹æ›¸ãã®ã¿ã€1æ—¥3å›
* [x] ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ãƒ—ãƒ©ãƒ³ä¾¡æ ¼ï¼ˆoverrideï¼‰
* [x] ã‚®ãƒ•ãƒˆã¯ãƒã‚¤ãƒ³ãƒˆå‹Aâ€™ã€å£²ä¸Šèªè­˜ãƒ™ãƒ¼ã‚¹
* [x] ã‚®ãƒ•ãƒˆãŒè´ˆã‚‰ã‚ŒãŸåˆ†ã ã‘ãŒã‚­ãƒ£ã‚¹ãƒˆã®åˆ†æ¯
* [x] æœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆã¯é…åˆ†å¯¾è±¡å¤–ï¼ˆé‹å–¶100%ï¼‰
* [x] é…åˆ†ã¯ç¨æŠœãƒ™ãƒ¼ã‚¹
* [x] webhookå†ªç­‰ã€ç›£æŸ»ãƒ­ã‚°å¿…é ˆã€RLSå¿…é ˆ

---

## ä»˜éŒ²Cï¼šè¨­è¨ˆå‰ãƒ’ã‚¢ãƒªãƒ³ã‚°çµæœï¼ˆåæ˜ ç‰ˆï¼‰

> æ—¢å­˜è¦ä»¶ã‚’è£œå®Œã™ã‚‹ãŸã‚ã®æ•´ç†ã€‚æ–­å®šã‚’é¿ã‘ã€é‹ç”¨åˆ¤æ–­ãŒå¿…è¦ãªç®‡æ‰€ã‚’æ˜ç¤ºã™ã‚‹ã€‚

### â‘  ç¾åœ¨ã®ç†è§£ï¼ˆä»®èª¬æ•´ç†ï¼‰

* ä»®ã‚¿ã‚¤ãƒˆãƒ«ï¼šRutinï¼ˆäººã«ã‚ˆã‚‹ç¿’æ…£åŒ–ä¼´èµ°ã®é‹ç”¨æ”¯æ´ï¼‰
* è§£æ±ºã—ãŸã„èª²é¡Œï¼ˆä»®ï¼‰ï¼š

  * ç¶™ç¶šã§ããªã„äººã®å­¤ç‹¬ã‚’å¯¾äººä¼´èµ°ã§è§£æ¶ˆ
  * é‹ç”¨ã¨å“è³ªã‚’ç¶­æŒã—ã¤ã¤åç›Šã‚’æˆç«‹ã•ã›ã‚‹
* æƒ³å®šåˆ©ç”¨è€…ï¼ˆä»®ï¼‰ï¼š

  * LINEåˆ©ç”¨è€…ï¼ˆã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
  * ç®¡ç†è€…ä¸­å¿ƒã®å°‘äººæ•°é‹ç”¨ï¼‹å“è³ªæ‹…å½“
* ã‚„ã‚ŠãŸã„ã“ã¨ï¼ˆçŸ­ãï¼‰ï¼š

  * äººã®è¿”ä¿¡ã§ä¿¡é ¼ã‚’ä¿ã¡ã€å±é™ºã‚„é…å»¶ã‚’è¦‹è½ã¨ã•ãªã„
* ~~æœªç¢ºå®šãªç‚¹~~ â†’ **ç¢ºå®šæ¸ˆã¿ï¼ˆæœ¬æ–‡æ›¸ã«åæ˜ æ¸ˆã¿ï¼‰**ï¼š

  * ~~è¿”ä¿¡ã®ç›®æ¨™æ™‚é–“ã®å…·ä½“å€¤~~ â†’ ç¢ºå®šï¼ˆ5.2å‚ç…§ï¼‰
  * ~~å±é™ºæ¤œçŸ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åŸºæº–ã®è©³ç´°~~ â†’ MVPé™¤å¤–ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
  * ~~ä¾¡æ ¼å¤‰æ›´ã®åˆ¤æ–­åŸºæº–ï¼ˆå³æ™‚/æ¬¡å›ã®å…·ä½“ãƒ«ãƒ¼ãƒ«ï¼‰~~ â†’ ç¢ºå®šï¼ˆ5.3å‚ç…§ï¼‰
  * ~~æœ¬äººç¢ºèªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å´ï¼‰ã®å…·ä½“æ–¹æ³•~~ â†’ ç¢ºå®šï¼ˆ7.4å‚ç…§ï¼šJWTï¼‰

### â‘¡ ã€Œæ±ºã‚ãªã„ã¨å£Šã‚Œã‚‹è«–ç‚¹ã€æ´—ã„å‡ºã— â†’ **å…¨ã¦ç¢ºå®šæ¸ˆã¿**

| è«–ç‚¹ | ãªãœä»Šæ±ºã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ | æ±ºã‚ãªã„å ´åˆã®ãƒªã‚¹ã‚¯ | ç¢ºå®šçŠ¶æ³ |
| --- | --- | --- | --- |
| è¿”ä¿¡ã®ç›®æ¨™æ™‚é–“ | å„ªå…ˆé †ä½ã¨é‹ç”¨è² è·ã®åŸºæº–ã«ãªã‚‹ | å¯¾å¿œãŒã°ã‚‰ã¤ãé‹ç”¨ãŒç ´ç¶» | âœ“ ç¢ºå®šï¼ˆ5.2å‚ç…§ï¼‰ |
| å±é™ºæ¤œçŸ¥ã®åŸºæº– | è¦‹è½ã¨ã—ã‚¼ãƒ­ãŒæˆåŠŸæ¡ä»¶ | é‡å¤§å¯¾å¿œã®é…ã‚Œãƒ»ä¿¡ç”¨å¤±å¢œ | âœ“ MVPé™¤å¤–ï¼ˆå°†æ¥æ‹¡å¼µï¼‰ |
| ä¾¡æ ¼å¤‰æ›´ã®åˆ¤æ–­åŸºæº– | åç›Šã¨èª¬æ˜è²¬ä»»ã«ç›´çµ | ä¾¡æ ¼ãŒã¶ã‚Œã¦èª¬æ˜ä¸èƒ½ | âœ“ ç¢ºå®šï¼ˆ5.3å‚ç…§ï¼‰ |
| æœ¬äººç¢ºèªã®æ–¹æ³• | ä¸æ­£è³¼å…¥ã‚„èª¤é€ä¿¡é˜²æ­¢ | ãªã‚Šã™ã¾ã—ã‚„èª¤è«‹æ±‚ | âœ“ ç¢ºå®šï¼ˆ7.4å‚ç…§ï¼‰ |
| è¿”é‡‘/èª¿æ•´æ–¹é‡ | åç›Šãƒ»é…åˆ†ã®æ•´åˆã«å½±éŸ¿ | ä¸æ•´åˆãƒ»é‹ç”¨æ··ä¹± | âœ“ ç¢ºå®šï¼ˆæ—¢å­˜ï¼‰ |

### â‘¢ åˆ©ç”¨è€…ãƒ»å½¹å‰²ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆé¸æŠå¼ã®çµè«–ï¼‰

* é‹ç”¨ä¸»ä½“ï¼š**ç®¡ç†è€…ãŒä¸­å¿ƒï¼ˆå°‘äººæ•°ï¼‰**
* ä»£ç†è¿”ä¿¡ã®è¨±å¯ç¯„å›²ï¼š**ç®¡ç†è€…ã¨å“è³ªæ‹…å½“**
* ~~å±é™ºæ¤œçŸ¥ã®åŸºæº–ï¼šæ˜ç¢ºãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸­å¿ƒ~~ â†’ **MVPé™¤å¤–ï¼ˆå°†æ¥æ‹¡å¼µï¼‰**
* è¿”ä¿¡ã®é‹ç”¨æ–¹é‡ï¼š**çŠ¶æ³ã«å¿œã˜ã¦æŸ”è»Ÿã«**
* è¿”é‡‘/ãƒãƒ£ãƒ¼ã‚¸ãƒãƒƒã‚¯ï¼š**åŸºæœ¬çš„ã«ã—ãªã„**

### â‘£ æ¥­å‹™ãƒ•ãƒ­ãƒ¼ã®ãŸãŸãï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼‰

* é–‹å§‹ç‚¹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ç›¸è«‡ã‚„å ±å‘ŠãŒå±Šã
* ä¸­é–“ï¼ˆæœ€å¤§5ã‚¹ãƒ†ãƒƒãƒ—ï¼‰ï¼š

  1. æ‹…å½“è€…ãŒå†…å®¹ã‚’ç¢ºèªã™ã‚‹
  2. å¿…è¦ãªã‚‰ãƒ¡ãƒ¢ã‚„è£œè¶³ã‚’æ®‹ã™
  3. è¿”ä¿¡å†…å®¹ã‚’ä½œã‚‹ï¼ˆå¿…è¦ãªã‚‰ä¸‹æ›¸ãã‚„ææ¡ˆï¼‰
  4. é€ä¿¡å‰ã«ç¢ºèªã—ã¦è¿”ä¿¡ã™ã‚‹
  5. å¿…è¦ãªã‚‰ç®¡ç†è€…ãŒçŠ¶æ³ã‚’ç¢ºèªã™ã‚‹
* çµ‚äº†ç‚¹ï¼šè¿”ä¿¡ãŒå®Œäº†ã—ã€å±¥æ­´ã¨è¨˜éŒ²ãŒæ®‹ã‚‹

### â‘¤ çµ¶å¯¾ã«ã‚„ã‚ŠãŸã„ã“ã¨ / ã‚„ã‚‰ãªã„ã“ã¨

* Mustï¼š

  * äººãŒè¿”ä¿¡ã™ã‚‹ï¼ˆè‡ªå‹•é€ä¿¡ãªã—ï¼‰
  * å±é™ºå¯¾å¿œã®è¦‹è½ã¨ã—ã‚’é˜²ã
  * åç›Šã¨é…åˆ†ãŒä¸€è²«ã—ã¦è¨ˆç®—ã§ãã‚‹
  * é€ä¿¡ä¸å¯ã®äººãŒé€ä¿¡ã§ããªã„
* Wonâ€™tï¼š

  * è‡ªå‹•è¿”ä¿¡ãƒ»è‡ªå‹•é€ä¿¡
  * é€šè©±ã‚„æ˜ åƒã§ã®å¯¾å¿œ
  * é«˜åº¦ãªè‡ªå‹•åˆ¤æ–­ã§ã®ä»‹å…¥

### â‘¥ æˆåŠŸæ¡ä»¶ï¼ˆå®Œæˆã®å®šç¾©ï¼‰

* åˆ©ç”¨è€…è¦–ç‚¹ï¼šäººé–“å‘³ã®ã‚ã‚‹è¿”ä¿¡ã§ç¶™ç¶šã§ãã‚‹å®Ÿæ„ŸãŒã‚ã‚‹
* é‹ç”¨è€…è¦–ç‚¹ï¼šé‡è¦å¯¾å¿œãŒæ¼ã‚Œãšã€åç›Šã¨é…åˆ†ãŒçŸ›ç›¾ãªãå›ã‚‹
* å¤±æ•—çŠ¶æ…‹ï¼šé‡è¦ç›¸è«‡ã®æ”¾ç½®ã€é€ä¿¡ç¦æ­¢ã®ç ´ã‚Œã€è¨ˆç®—ã®èª¬æ˜ä¸èƒ½

### â‘¦ ãƒªã‚¹ã‚¯ã¨ä¸å®‰ã®æ˜æ–‡åŒ–

* é–“é•ã£ãŸæ“ä½œãŒæ€–ã„ â†’ äºŒé‡ç¢ºèªã¨è¨˜éŒ²ã§é˜²ãï¼ˆä»®ï¼‰
* äººæ‰‹ãŒè¶³ã‚Šãšå›ã‚‰ãªã„ â†’ å„ªå…ˆé †ä½ã®åŸºæº–ã‚’æ˜ç¢ºåŒ–ï¼ˆä»®ï¼‰
* èª°ãŒä½•ã‚’ã—ãŸã‹åˆ†ã‹ã‚‰ãªããªã‚‹ â†’ æ“ä½œå±¥æ­´ã‚’å¿…ãšæ®‹ã™ï¼ˆä»®ï¼‰
* å¼•ãç¶™ããŒä¸å®‰ â†’ æ‹…å½“å±¥æ­´ã¨ãƒ¡ãƒ¢ã‚’æ®‹ã™ï¼ˆä»®ï¼‰

### â‘§ æ¬¡ã«ã‚„ã‚‹ã¹ãåˆ¤æ–­ãƒªã‚¹ãƒˆï¼ˆTo Decideï¼‰ â†’ **å…¨ã¦ç¢ºå®šæ¸ˆã¿**

* ~~ä»Šã™ãæ±ºã‚ã‚‹~~ â†’ **ç¢ºå®šæ¸ˆã¿**ï¼š

  * ~~è¿”ä¿¡ã®ç›®æ¨™æ™‚é–“ã®å…·ä½“å€¤~~ â†’ âœ“ ç¢ºå®šï¼ˆ5.2å‚ç…§ï¼‰
  * ~~å±é™ºæ¤œçŸ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åŸºæº–~~ â†’ âœ“ MVPé™¤å¤–ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
  * ~~ä¾¡æ ¼å¤‰æ›´ã®åˆ¤æ–­åŸºæº–~~ â†’ âœ“ ç¢ºå®šï¼ˆ5.3å‚ç…§ï¼‰
  * ~~æœ¬äººç¢ºèªã®æ–¹æ³•~~ â†’ âœ“ ç¢ºå®šï¼ˆ7.4å‚ç…§ï¼šJWTï¼‰
* ~~MVPå‰ã«æ±ºã‚ã‚‹~~ â†’ **ç¢ºå®šæ¸ˆã¿**ï¼š

  * ~~ä»£ç†è¿”ä¿¡ã®å…·ä½“é‹ç”¨ï¼ˆã©ã®å ´é¢ã§è¡Œã†ã‹ï¼‰~~ â†’ âœ“ ç¢ºå®šï¼ˆ8.8å‚ç…§ï¼‰
  * ~~ã‚®ãƒ•ãƒˆå•†å“ã®å…·ä½“å†…å®¹ã¨ä¾¡æ ¼å¸¯~~ â†’ âœ“ ç¢ºå®šï¼ˆ12.4å‚ç…§ï¼‰
* å®Ÿè£…å¾Œã§ã‚‚è‰¯ã„ï¼š

  * ã‚ˆã‚Šé«˜åº¦ãªå±é™ºæ¤œçŸ¥ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
  * é‹ç”¨è² è·ã®è‡ªå‹•æœ€é©åŒ–

---

ä»¥ä¸ŠãŒã€Œå®Œå…¨ç‰ˆãƒ»çœç•¥ãªã—ã€ã®è¦ä»¶å®šç¾©æ›¸ã§ã™ã€‚

æ¬¡ã« Cursor å®Ÿè£…ã‚’æœ€çŸ­åŒ–ã™ã‚‹ãŸã‚ã«ã€ã‚ãªãŸãŒæœ›ã‚€ãªã‚‰ã“ã®è¦ä»¶å®šç¾©æ›¸ã‚’ãã®ã¾ã¾ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ **ã€ŒSupabase migrationsï¼ˆSQLå®Œå…¨ç‰ˆï¼‰ã€ã€ŒRLSãƒãƒªã‚·ãƒ¼ï¼ˆSQLï¼‰ã€ã€ŒServer Actionsã®I/Oå®šç¾©ã€ã€Œç”»é¢åˆ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆã€ã€Œãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¡¨ã€**ã¾ã§ã€ã‚³ãƒ”ãƒšå¯èƒ½ãªç²’åº¦ã§å‡ºåŠ›ã§ãã¾ã™ã€‚
